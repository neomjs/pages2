import e from"../core/Base.mjs";import t from"./Filter.mjs";import r from"../core/Logger.mjs";import s from"./Sorter.mjs";import i from"../core/Observable.mjs";import o from"../core/Util.mjs";const l=Symbol("countMutations"),n=Symbol("isFiltered"),a=Symbol("isSorted"),p=Symbol("silentUpdateMode"),u=Symbol("toAddArray"),h=Symbol("toRemoveArray"),m=Symbol("updatingIndex");class d extends e{static getStaticConfig(){return{observable:!0}}static getConfig(){return{className:"Neo.collection.Base",ntype:"collection",allItems:null,autoSort:!0,filterMode:"primitive",filters_:[],items_:null,keyProperty:"id",keyPropertyIndex:-1,map_:null,sortDirections:null,sortProperties:null,sorters_:[],sourceId_:null}}constructor(e){super(e);let t=this,r={enumerable:!1,writable:!0};t.items=t.items||[],Object.defineProperties(t,{[l]:{...r,value:!1},[n]:{...r,value:!1},[a]:{...r,value:!1},[p]:{...r,value:!1},[u]:{...r,value:[]},[h]:{...r,value:[]},[m]:{...r,value:0}}),t.autoSort&&t._sorters.length>0&&t.doSort()}add(e){return this.splice(0,null,e).addedItems}afterSetFilters(e,t){let r=this;e.forEach((e=>{!1===e.listenerApplied&&(e.on("change",r.onFilterChange,r),e.listenerApplied=!0)})),t&&r.filter()}afterSetItems(e,t){if(e){let t,r=this,s=r.keyProperty,i=0,o=e.length;for(;i<o;i++)t=e[i],r.map.set(t[s],t)}}afterSetSorters(e,t){let r=this;r.applySorterConfigs(),e.forEach((e=>{!1===e.listenerApplied&&(e.on("change",r.onSorterChange,r),e.listenerApplied=!0)})),t&&r.autoSort&&r.doSort()}afterSetSourceId(e,t){if(e){let r=this,s=Neo.get(e);r._items=[...s._items],r.map=new Map(s.map);const i={mutate:r.onMutate,scope:r};s.on(i),t&&(s=Neo.get(t),s.un(i))}}applySorterConfigs(){let e=this;e.sortDirections=[],e.sortProperties=[],e.sorters.forEach((t=>{e.sortDirections.push(t.directionMultiplier),e.sortProperties.push(t.property)}))}beforeSetFilters(e,r){Array.isArray(e)||(e=e?[e]:[]);let s,i,o=r&&r.length||0;return e.forEach(((l,n)=>{if(r)for(s=!1,i=0;i<o;i++){if(r[i]===l){r[i].set({operator:l.operator,property:l.property,value:l.value}),s=!0;break}if(r[i].operator===(l.operator||"===")&&r[i].property===l.property&&r[i].value===l.value){s=!0;break}}s?(e[n]=r[i],r.splice(i,1),o--):e[n]=Neo.create(t,l)})),Array.isArray(r)&&r.forEach((e=>{e.destroy()})),e}beforeSetMap(e,t){return e||new Map}beforeSetSorters(e,t){Array.isArray(e)||(e=e?[e]:[]);let r,i,o=t?.length||0;return e.forEach(((l,n)=>{if(t)for(r=!1,i=0;i<o;i++){if(t[i]===l){t[i].set({direction:l.direction,property:l.property}),r=!0;break}if(t[i].property===l.property&&t[i].direction===l.direction){r=!0;break}}r?(e[n]=t[i],t.splice(i,1),o--):e[n]=Neo.create(s,l)})),Array.isArray(t)&&t.forEach((e=>{e.destroy()})),e}cacheUpdate(e){console.log("cacheUpdate",e,this[u])}clear(){let e=this;e._items.splice(0,e.getCount()),e.map.clear()}clearFilters(e){this.filters=e?Neo.clone(this.originalConfig.filters,!0,!0):null}clearSorters(e){this.sorters=e?Neo.clone(this.originalConfig.sorters,!0,!0):null}clone(){let e=this,t=Neo.clone(e.originalConfig,!0),r=e._filters||[],s=e._sorters||[];return delete t.id,delete t.filters,delete t.items,delete t.sorters,e._items.length>0&&(t.items=[...e._items]),t.filters=[],t.sorters=[],r.forEach((function(e){t.filters.push(e.originalConfig)})),s.forEach((function(e){t.sorters.push(e.originalConfig)})),Neo.create(d,t)}destroy(){let e=this;e.items.splice(0,e._items.length),e.map.clear(),super.destroy()}doSort(){let e,t,r,s,i,o,l=this,n=l._items,p=l.sorters,u=l.sortDirections,h=l.sortProperties,d=h.length||0,f=!1,c=!1;d>0&&(p.forEach((e=>{e.sortBy&&(f=!0),e.useTransformValue&&(c=!0)})),f?l._items.sort(((t,r)=>{for(e=0;e<d;e++)if(s=p[e],o=s[s.sortBy?"sortBy":"defaultSortBy"](t,r),0!==o)return o;return 0})):(t=c?n.map(((t,s)=>{for(r={index:s},e=0;e<d;e++)p[e].useTransformValue?r[h[e]]=p[e].transformValue(t[h[e]]):r[h[e]]=t[h[e]];return r})):n,t.sort(((t,r)=>{for(e=0;e<d;e++){if(i=h[e],t[i]>r[i])return 1*u[e];if(t[i]<r[i])return-1*u[e]}return 0})),c&&(l._items=t.map((e=>n[e.index]))))),l[a]=d>0,0===l[m]&&l.fire("sort")}endUpdate(e){const t=this;t[m]>0&&t[m]--,e?t[p]=!1:(t.fire("mutate",{addedItems:t[u],removedItems:t[h]}),t[u].splice(0,t[u].length),t[h].splice(0,t[h].length))}filter(){let e,t,r,s,i,o=this,l=o._filters,a=l.length,p=0,u=o.allItems?._items||o._items,h=0,m=u.length,f=[];for(;h<a;h++)l[h].disabled||p++;if(0===p&&o.allItems)o.clear(),o.items=[...o.allItems._items],o.map.set(...o.allItems.map);else if(o.allItems||(e={...o.originalConfig},delete e.filters,delete e.items,delete e.sorters,o.allItems=Neo.create(d,{...Neo.clone(e,!0,!0),keyProperty:o.keyProperty,sourceId:o.id})),o.map.clear(),"primitive"===o.filterMode){for(h=0;h<m;h++){for(t=!0,r=u[h],s=0;s<a;s++)if(l[s].isFiltered(r,u,u)){t=!1;break}t&&(f.push(r),o.map.set(r[o.keyProperty],r))}o._items=f}else{for(f=[...u],s=0;s<a;s++){for(i=[],h=0;h<m;h++)l[s].isFiltered(f[h],f,u)||i.push(f[h]);f=[...i],m=f.length}o.items=f}o[n]=0!==p,o.fire("filter")}find(e,t){let r,s,i,o=[],l=Neo.isObject(e);return l&&(s=Object.entries(e),i=s.length),this.items.forEach((n=>{l?(r=[],s.forEach((([e,t])=>{n[e]===t&&r.push(!0)})),r.length===i&&o.push(n)):n[e]===t&&o.push(n)})),o}findBy(e,t=this,r,s){let i=this,o=[],l=r||0,n=s||i.getCount();for(;l<n;l++)e.call(t,i.items[l])&&o.push(i.items[l]);return o}first(){return this._items[0]}get(e){return this.map.get(e)}getAt(e){return this._items[e]}getCount(){return this._items.length}getCountMutations(){return this[l]}getFilter(e){let t=this.filters||[],r=0,s=t.length;for(;r<s;r++)if(t[r].property===e)return t[r];return null}getKeyAt(e){let t=this._items[e];return t?.[this.keyProperty]}getRange(e,t){return this._items.slice(e,t)}getSource(){return this.sourceId&&Neo.get(this.sourceId)}has(e){return this.map.has(e)}hasItem(e){return this.map.has(e[this.keyProperty])}indexOf(e){return this._items.indexOf(o.isObject(e)?e:this.map.get(e))}indexOfItem(e){return this._items.indexOf(e)}indexOfKey(e){return this._items.indexOf(this.map.get(e))}insert(e,t){return this.splice(e,0,t).addedItems}isFiltered(){return this[n]}isFilteredItem(e){let t=this._filters,r=0,s=t.length,i=!1;for(;r<s;r++)if(t[r].isFiltered(e)){i=!0;break}return i}isSorted(){return this[a]}last(){return this._items[this.getCount()-1]}onFilterChange(e){this.filter()}onMutate(e){let t=this;e.preventBubbleUp&&(t.preventBubbleUp=!0),t.splice(null,e.removedItems,e.addedItems)}onSorterChange(e){this.applySorterConfigs(),this.doSort()}pop(){return this.splice(this.getCount()-1,1).removedItems[0]}push(e){return this.add(e)}remove(e){return this.splice(0,Array.isArray(e)?e:[e]),this.getCount()}removeAt(e){return this.splice(e,1),this.getCount()}reverse(){return this._items.reverse()}shift(){return this.splice(0,1).addedItems[0]}some(...e){return this._items.some(...e)}splice(e,t,s){let i,n,a,u,h,d=this,f=d.getSource(),c=[],g=d._items,y=d.keyProperty,b=d.map,S=[],I=o.isNumber(t)?t:null,_=Array.isArray(t)?t:null;if(!e&&I&&r.error(d.id+": If index is not passed, removeCountAtIndex cannot be used"),s=s&&!Array.isArray(s)?[s]:s,_&&(u=_.length)>0)for(s&&s.length>0&&(h=s.map((e=>e[y]))),i=0;i<u;i++)n=_[i],a=o.isObject(n)?n[y]:n,b.has(a)&&(!h||h&&h.indexOf(a)<0)&&(S.push(g.splice(d.indexOfKey(a),1)[0]),b.delete(a));else I&&I>0&&(S.push(...g.splice(e,I)),S.forEach((e=>{b.delete(e[y])})));if(s&&(u=s.length)>0){for(i=0;i<u;i++)n=s[i],a=n[y],a||(n[y]=a=d.keyPropertyIndex,d.keyPropertyIndex--),b.has(a)||d.isFilteredItem(n)||(c.push(n),b.set(a,n));c.length>0&&(g.splice(o.isNumber(e)?e:g.length,0,...c),d.autoSort&&d._sorters.length>0&&d.doSort())}return f&&(f.getSource()||(f.preventBubbleUp=!0),d.preventBubbleUp||(d.startUpdate(!0),f.splice(null,_||S,s),d.endUpdate(!0)),delete f.preventBubbleUp),(c.length>0||S.length>0)&&d[l]++,0===d[m]?d.fire("mutate",{addedItems:s,preventBubbleUp:d.preventBubbleUp,removedItems:_||S}):d[p]||d.cacheUpdate({addedItems:c,removedItems:S}),0===d[m]&&delete d.preventBubbleUp,{addedItems:c,removedItems:S}}startUpdate(e){e&&(this[p]=!0),this[m]++}unshift(e){return this.splice(0,0,e),this.getCount()}}Neo.applyClassConfig(d);export default d;