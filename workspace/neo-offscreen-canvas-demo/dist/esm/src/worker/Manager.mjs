import e from"../core/Base.mjs";import r from"../main/DomAccess.mjs";import s from"../main/DomEvents.mjs";import o from"./Message.mjs";import a from"../core/Observable.mjs";import t from"./mixin/RemoteMethodAccess.mjs";const n=Neo.config,i="development"===n.environment;class m extends e{static getConfig(){return{className:"Neo.worker.Manager",singleton:!0,activeWorkers:0,appNames:[],basePath:n.workerBasePath||"worker/",constructedThreads:0,mixins:[a,t],sharedWorkersEnabled:!1,stopCommunication:!1,webWorkersEnabled:!1,workers:{app:{fileName:i?"App.mjs":"appworker.js"},canvas:{fileName:i?"Canvas.mjs":"canvasworker.js"},data:{fileName:i?"Data.mjs":"dataworker.js"},vdom:{fileName:i?"VDom.mjs":"vdomworker.js"}}}}constructor(e){super(e);let o=this;o.detectFeatures(),Neo.insideWorker||o.createWorkers(),Neo.workerId="main",o.promises={},o.on({"message:addDomListener":{fn:s.addDomListener,scope:s},"message:getOffscreenCanvas":{fn:r.onGetOffscreenCanvas,scope:r},"message:readDom":{fn:r.onReadDom,scope:r},"message:registerRemote":{fn:o.onRegisterRemote,scope:o},"message:workerConstructed":{fn:o.onWorkerConstructed,scope:o}})}broadcast(e){Object.keys(this.workers).forEach((r=>{this.sendMessage(r,e)}))}createWorker(e){let r=this,s=e.fileName,o=(e.basePath||r.basePath)+s,a=`neomjs-${s.substring(0,s.indexOf(".")).toLowerCase()}-worker`,t=r.sharedWorkersEnabled&&n.useSharedWorkers,m=t?SharedWorker:Worker,d=new m(o,i?{name:a,type:"module"}:{name:a});return(t?d.port:d).onmessage=r.onWorkerMessage.bind(r),(t?d.port:d).onerror=r.onWorkerError.bind(r),r.activeWorkers++,d}createWorkers(){let e,r,o=this,a=location.hash;for([e,r]of(a&&(n.hash={hash:s.parseHash(a.substr(1)),hashString:a.substr(1)}),Object.entries(o.workers)))if("canvas"!==e||n.useCanvasWorker){try{r.worker=o.createWorker(r)}catch(e){document.body.innerHTML=e,o.stopCommunication=!0;break}o.sendMessage(e,{action:"registerNeoConfig",data:n})}}detectFeatures(){let e=this;if(n.hasTouchEvents="ontouchstart"in window||navigator.maxTouchPoints>0,!window.Worker)throw new Error("Your browser does not support Web Workers");e.webWorkersEnabled=!0,window.SharedWorker&&(e.sharedWorkersEnabled=!0)}getWorker(e){return e instanceof Worker?e:this.workers[e].worker}loadApplication(e){this.sendMessage("app",{action:"loadApplication",path:e,resourcesPath:n.resourcesPath})}onWorkerConstructed(e){let r=this;r.constructedThreads++,r.constructedThreads===r.activeWorkers&&n.appPath&&setTimeout((()=>{r.loadApplication(n.appPath)}),20)}onWorkerError(e){!i&&console.log("Worker Error:",e)}onWorkerMessage(e){let r,s=this,o=e.data,a=!1,t=null;const{action:n,destination:i,replyId:m}=o;s.fire("message:"+n,o),(r="reply"===n&&s.promises[m])&&("main"===o.destination&&(o=o.data),o.reject?r.reject(o):(o.data&&(o.data.autoMount&&(s.fire("automount",o),a=!0),o.data.updateVdom&&(s.fire("updateVdom",o),a=!0)),a?s.promises[m].data=o:r.resolve(o)),a||delete s.promises[m]),"main"!==i&&"reply"!==n?(o.transfer&&(t=[o.transfer]),s.promiseMessage(i,o,t).then((e=>{s.sendMessage(e.destination,e)})).catch((e=>{s.sendMessage(o.origin,{action:"reply",reject:!0,replyId:o.id,error:e.message})}))):"main"===i&&"registerAppName"===n?s.appNames.push(o.appName):"main"===i&&"remoteMethod"===n&&s.onRemoteMethod(o)}promiseMessage(e,r,s){let o=this;return new Promise(((a,t)=>{let n=o.sendMessage(e,r,s).id;o.promises[n]={reject:t,resolve:a}}))}resolveDomOperationPromise(e){if(e){let r=this.promises[e];r&&(r.resolve(r.data),delete this.promises[e])}}sendMessage(e,r,s){let a,t,i=this;if(!i.stopCommunication){if(t=i.getWorker(e),!t)throw new Error("Called sendMessage for a worker that does not exist: "+e);return r.destination=e,a=new o(r),(i.sharedWorkersEnabled&&n.useSharedWorkers?t.port:t).postMessage(a,s),a}}}Neo.applyClassConfig(m);let d=Neo.create(m);Neo.applyToGlobalNs(d);export default d;