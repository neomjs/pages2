import e from"../core/Base.mjs";import t from"./Component.mjs";import o from"./Focus.mjs";import r from"../core/Logger.mjs";import n from"../util/Array.mjs";import i from"../util/VDom.mjs";const a=["bubble","delegate","local","scope","vnodeId"],s=["change","click","contextmenu","dblclick","drag:end","drag:move","drag:start","focusin","focusout","input","keydown","keyup","mousedown","mouseenter","mouseleave","mouseup","wheel"];class d extends e{static getConfig(){return{className:"Neo.manager.DomEvent",items:{},map:{},singleton:!0}}fire(e){let r,n,i,a,s=this,l=!0,m=e.data||{},p=e.eventName,c=0,g=null,f=m.path.map((e=>e.id)),u=t.getParentPath(f),h=u.length;for(;c<h&&(i=u[c],r=Neo.getComponent(i),r&&!r.disabled);c++){if(g=s.items[i]?.[p],g&&Array.isArray(g)&&g.forEach((e=>{e&&e.fn&&(n=s.verifyDelegationPath(e,m.path),!1!==n&&(a=!1,"mouseenter"!==p&&"mouseleave"!==p||(a=!d.verifyMouseEnterLeave(r,m,n,p)),a||(m.component=r,e.fn.apply(e.scope||self,[m]),e.bubble||(l=!1))))})),"focusin"===p||"focusout"===p){o["on"+Neo.capitalize(p)]({componentPath:u,data:m});break}if(!l)break}if(p.startsWith("drop")){let e=m.dragZoneId&&Neo.get(m.dragZoneId);e&&(e.fire(p,m),e[{drop:"onDrop","drop:enter":"onDropEnter","drop:leave":"onDropLeave"}[p]].call(e,m))}}generateListenerConfig(e,t){return{delegate:e.delegate,eventName:e.eventName,id:t.id,opts:e,scope:e.scope||t,vnodeId:e.vnodeId||t.id}}getEventName(e){let t=null;return Neo.isObject(e)&&Object.keys(e).forEach((e=>{a.includes(e)||(t=e)})),t}getListener(e){let t,o=this.items;if(o?.[e.id])return t=o[e.id][e.eventName],t||null}mountDomListeners(e){let t=this.items[e.id],o=[];t&&(Object.entries(t).forEach((([e,t])=>{t.forEach((t=>{!(e=t.eventName)||!t.local&&s.includes(e)||o.push({name:e,handler:"domEventListener",vnodeId:t.vnodeId})}))})),o.length>0&&Neo.worker.App.promiseMessage("main",{action:"addDomListener",appName:e.appName,events:o}).then((e=>{})).catch((e=>{console.log("App: Got error attempting to add a domListener",e)})))}register(e){let t,o,r,n,i=!1,a=e.eventName,d=e.id,l=this.items,m=e.opts,p=e.scope,c=typeof m;return"function"===c||"string"===c?t=m:(t=m.fn,p=m.scope||p),l[d]||(l[d]={}),l[d][a]?(o=l[d][a],Object.keys(o).forEach((r=>{o[r].fn.toString()===t.toString()&&o[r].scope===p&&o[r].delegate===e.delegate&&(i=!0)}))):l[d][a]=[],!0!==i&&(n=Neo.getId("dom-event"),e.listenerId=n,r={bubble:e.hasOwnProperty("bubble")?e.bubble:!m.hasOwnProperty("bubble")||m.bubble,delegate:e.delegate,eventName:a,fn:t,id:n,mounted:!e.local&&s.includes(a),originalConfig:e.originalConfig,ownerId:e.ownerId,priority:e.priority||1,scope:p,vnodeId:e.vnodeId},this.map[n]=r,l[d][a].push(r),l[d][a].sort(((e,t)=>e.priority>t.priority)),!0)}unregister(e,t){console.log("unregister",e),console.log(this.generateListenerConfig(e,t))}updateDomListeners(e,t,o){let i,s,d,l=this,m=l.items[e.id]||{};Array.isArray(t)?(Array.isArray(o)&&o.forEach((e=>{if(!t.includes(e))for(d=m[l.getEventName(e)]||[],i=0,s=d.length;i<s;i++)if(d[i].originalConfig===e){n.remove(d,d[i]);break}})),t.forEach((t=>{Object.entries(t).forEach((([o,r])=>{a.includes(o)||l.register({delegate:t.delegate||r.delegate||"#"+e.id,eventName:o,id:e.id,opts:r,originalConfig:t,ownerId:e.id,scope:t.scope||e,vnodeId:t.vnodeId||r.vnodeId||e.id})}))})),e.mounted&&l.mountDomListeners(e)):r.logError("Component.domListeners have to be an array",e)}updateListenerPlaceholder(e){let t,o=(this.items[e.componentId]||{})[e.eventName]||[],r=0,n=o.length;for(;r<n;r++)if(t=o[r],t.fn===e.eventHandlerName){t.fn=e.eventHandlerMethod,t.scope=e.scope;break}}verifyDelegationPath(e,t){let o,r,n,i,a,s=e.delegate.split(" "),d=0,l=s.length,m=t.length;for(r=l-1;r>=0;r--){for(o=!1,n=s[r],i=n.startsWith("#"),(i||n.startsWith("."))&&(n=n.substr(1));d<m;d++)if(i&&t[d].id===n||t[d].cls.includes(n)){o=!0,a=t[d].id;break}if(!o)return!1}for(;d<m;d++)if(t[d].id===e.vnodeId)return a;return!1}static verifyMouseEnterLeave(e,t,o,r){let n,a="mouseenter"===r?t.fromElementId:t.toElementId;return!(a&&a!==o&&(n=i.findVdomChild(e.vdom,o),!n||n.vdom&&i.findVdomChild(n.vdom,a)))}}Neo.applyClassConfig(d);let l=Neo.create(d);Neo.applyToGlobalNs(l);export default l;