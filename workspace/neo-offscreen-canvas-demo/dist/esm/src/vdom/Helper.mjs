import e from"../core/Base.mjs";import d from"../util/Array.mjs";import t from"../util/Style.mjs";import n from"./VNode.mjs";import i from"../util/VNode.mjs";class o extends e{returnChildNodeOuterHtml=!1;voidAttributes=["checked","required"];voidElements=["area","base","br","col","command","embed","hr","img","input","keygen","link","meta","param","source","track","wbr"];static getConfig(){return{className:"Neo.vdom.Helper",remote:{app:["create","update"]},singleton:!0}}create(e){let d,t=e.appName,n=!0===e.autoMount,i=e.parentId,o=e.parentIndex;return delete e.appName,delete e.autoMount,delete e.parentId,delete e.parentIndex,d=this.parseHelper(e),d.outerHTML=this.createStringFromVnode(d),n&&Object.assign(d,{appName:t,autoMount:!0,parentId:i,parentIndex:o}),d}createCloseTag(e){return this.voidElements.indexOf(e.nodeName)>-1?"":"</"+e.nodeName+">"}createDeltas(e){let n,o,r,a,s,l,c,p,h,u,m,N,f,V,x,v=this,g=e.deltas||[],y=e.index,b=e.newVnode,I=e.newVnodeRoot||b,H=e.oldVnode,T=e.oldVnodeRoot||H,w=e.parentId;if(b&&!H)T&&(h=v.findVnode(T,b.id,H)),h||g.push({action:"insertNode",id:b.id,index:y,outerHTML:v.createStringFromVnode(b),parentId:w});else if(!b&&H)I&&(p=v.findVnode(I,H.id,b)),p?(g.push({action:"moveNode",id:H.id,index:p.index,parentId:p.parentNode.id}),h=v.findVnode(T,p.parentNode.id),v.createDeltas({deltas:g,newVnode:p.vnode,newVnodeRoot:I,oldVnode:H,oldVnodeRoot:T,parentId:p.parentNode.id}),h.vnode.childNodes.splice(p.index,0,p.vnode)):g.push({action:"removeNode",id:H.id});else{if(b&&H&&b.id!==H.id){if(p=v.findVnode(I,H.id,b),h=v.findVnode(T,b.id,H),!p&&!h)return g.push({action:"removeNode",id:H.id}),g.push({action:"insertNode",id:b.id,index:y,outerHTML:v.createStringFromVnode(b),parentId:w}),{indexDelta:0};if(p&&h&&p.parentNode.id===h.parentNode.id)g.push({action:"moveNode",id:h.vnode.id,index:y,parentId:w}),v.createDeltas({deltas:g,newVnode:b,newVnodeRoot:I,oldVnode:h.vnode,oldVnodeRoot:T,parentId:p.parentNode.id});else{if(!p&&h){if(b.id===h.vnode.id){if(s=0,i.findChildVnodeById(H,b.id))g.push({action:"replaceChild",fromId:H.id,parentId:w,toId:b.id});else{let e=i.findChildVnode(T,h.vnode.id),d=i.findChildVnode(T,H.id);if(s=1,e.parentNode.id===d.parentNode.id){let t=i.findChildVnode(I,b.id),n=y+1;for(a=y+1,V=d.parentNode.childNodes,c=e.index;a<c;a++)i.findChildVnode(t.parentNode,V[a].id)||n++;e.parentNode.childNodes.splice(e.index,1),e.index!==n&&g.push({action:"moveNode",id:h.vnode.id,index:y,parentId:w}),s=0}g.push({action:"removeNode",id:H.id,parentId:w})}return v.createDeltas({deltas:g,newVnode:b,newVnodeRoot:I,oldVnode:h.vnode,oldVnodeRoot:T,parentId:w}),{indexDelta:s}}return g.push({action:"removeNode",id:H.id}),{indexDelta:1}}if(!h)return x=p&&i.findChildVnodeById(b,H.id),x&&g.push({action:"removeNode",id:p.vnode.id}),g.push({action:"insertNode",id:b.id,index:y,outerHTML:v.createStringFromVnode(b),parentId:w}),{indexDelta:x?0:-1};if(p){s=0;let e=i.findChildVnode(I,b.id),d=e.parentNode.id===p.parentNode.id;return d&&e.index>p.index&&(s=e.index-p.index),d&&e.parentNode.childNodes[p.index].id===p.vnode.id||g.push({action:"moveNode",id:p.vnode.id,index:p.index,parentId:p.parentNode.id}),v.createDeltas({deltas:g,newVnode:p.vnode,newVnodeRoot:I,oldVnode:H,oldVnodeRoot:T,parentId:p.parentNode.id}),{indexDelta:0}}}}b&&H&&b.id===H.id&&("text"===b.vtype&&b.innerHTML!==H.innerHTML?g.push({action:"updateVtext",id:b.id,parentId:i.findChildVnode(I,b.id).parentNode.id,value:b.innerHTML}):(l=Object.keys(b),Object.keys(H).forEach((e=>{b.hasOwnProperty(e)?"attributes"===e&&Object.keys(H[e]).forEach((d=>{b[e].hasOwnProperty(d)||(b[e][d]=null)})):l.push(e)})),l.forEach((e=>{switch(o={},r=b[e],e){case"attributes":n={},Object.entries(r).forEach((([e,d])=>{H.attributes.hasOwnProperty(e)&&H.attributes[e]===d||!Neo.isString(d)&&Neo.isEmpty(d)||(n[e]=d)})),Object.keys(n).length>0&&(o.attributes=n,Object.entries(n).forEach((([e,d])=>{null!==d&&""!==d||delete b.attributes[e]})));break;case"childNodes":for(a=0,s=0,c=Math.max(r.length,H.childNodes.length);a<c;a++)f=v.createDeltas({deltas:g,index:a,newVnode:r[a],newVnodeRoot:I,oldVnode:H.childNodes[a+s],oldVnodeRoot:T,parentId:b.id}),f&&f.indexDelta&&(s+=f.indexDelta);if(s<0)for(a=r.length+s;a<H.childNodes.length;a++)g.push({action:"removeNode",id:H.childNodes[a].id});break;case"nodeName":case"innerHTML":r!==H[e]&&(o[e]=r);break;case"style":u=t.compareStyles(r,H.style),u&&(o.style=u);break;case"className":H.className?(m=d.difference(r,H.className),N=d.difference(H.className,r)):(m=r,N=[]),(m.length>0||N.length>0)&&(o.cls={add:m,remove:N})}Object.keys(o).length>0&&(o.id=b.id,g.push(o))}))))}return g}createOpenTag(e){let d,t="<"+e.nodeName,n=e.attributes,i=e.className;return e.style&&(d=Neo.createStyles(e.style),""!==d&&(t+=` style="${d}"`)),i&&(Array.isArray(i)&&(i=i.join(" ")),""!==i&&(t+=` class="${i}"`)),e.id&&(Neo.config.useDomIds?t+=` id="${e.id}"`:t+=` data-neo-id="${e.id}"`),Object.entries(n).forEach((([e,d])=>{this.voidAttributes.includes(e)?"true"===d&&(t+=` ${e}`):"removeDom"!==e&&(t+=` ${e}="${d}"`)})),t+">"}createStringFromVnode(e){let d=this;switch(e.vtype){case"root":return d.createStringFromVnode(e.childNodes[0]);case"text":return void 0===e.innerHTML?"":String(e.innerHTML);case"vnode":return d.createOpenTag(e)+d.createTagContent(e)+d.createCloseTag(e);default:return""}}createTagContent(e){if(e.innerHTML)return e.innerHTML;let d,t,n="",i=e.childNodes?e.childNodes.length:0,o=0;for(;o<i;o++)d=e.childNodes[o],t=this.createStringFromVnode(d),d.innerHTML!==t&&this.returnChildNodeOuterHtml&&(d.outerHTML=t),n+=t;return n}findVnode(e,d,t,n){n||(n=0);let i,o,r,a,s=null;if(e.id===d)s={index:n,parentNode:t,vnode:e};else if("text"!==e.vtype)for(i=e.childNodes,r=0,a=i?.length||0;r<a;r++)if(o=this.findVnode(i[r],d,e,r),o&&o.vnode.id===d){s=o;break}return s&&"root"===s.parentId&&(s.index=null),s}parseHelper(e){if(!0===e.removeDom)return null;if("text"===e.vtype)return e.id||(e.id=Neo.getId("vtext")),e.innerHTML=`\x3c!-- ${e.id} --\x3e${e.html||""}\x3c!-- /neo-vtext --\x3e`,delete e.html,e;let d,t=this,i={attributes:{},childNodes:[],style:{}};return e.tag||(e.tag="div"),Object.entries(e).forEach((([e,n])=>{let o,r,a;if(null!=n&&"flag"!==e)switch(e){case"tag":case"nodeName":i.nodeName=n;break;case"html":case"innerHTML":i.innerHTML=n.toString();break;case"children":case"childNodes":case"cn":Array.isArray(n)||(n=[n]),r=[],n.forEach((e=>{!0!==e.removeDom&&(delete e.removeDom,d=t.parseHelper(e),d&&r.push(d))})),i.childNodes=r;break;case"cls":n&&!Array.isArray(n)?i.className=[n]:Array.isArray(n)&&n.length<1||(i.className=n);break;case"height":case"maxHeight":case"maxWidth":case"minHeight":case"minWidth":case"width":o=n!=parseInt(n),i.style[e]=n+(o?"":"px");break;case"id":i.id=n;break;case"style":a=i.style,Neo.isString(n)?i.style=Object.assign(a,Neo.core.Util.createStyleObject(n)):i.style=Object.assign(a,n);break;default:"removeDom"!==e&&(i.attributes[e]=n+"")}})),new n(i)}update(e){let d=this.parseHelper(e.vdom);return{deltas:this.createDeltas({newVnode:d,oldVnode:e.vnode}),updateVdom:!0,vnode:d}}}Neo.applyClassConfig(o);let r=Neo.create(o);Neo.applyToGlobalNs(r);export default r;