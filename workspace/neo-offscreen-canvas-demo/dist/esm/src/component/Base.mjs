import e from"../util/ClassSystem.mjs";import t from"../manager/Component.mjs";import o from"../core/Base.mjs";import n from"../manager/DomEvent.mjs";import r from"../util/KeyNavigation.mjs";import d from"../core/Logger.mjs";import s from"../util/Array.mjs";import i from"../core/Observable.mjs";import a from"../util/Style.mjs";import m from"../core/Util.mjs";import l from"../util/VDom.mjs";import p from"../util/VNode.mjs";class h extends o{static getStaticConfig(){return{observable:!0}}static getConfig(){return{className:"Neo.component.Base",ntype:"component",appName_:null,autoMount:!1,autoRender:!1,bind:null,containsFocus_:!1,controller_:null,data_:null,disabled_:!1,domListeners_:null,droppable_:!1,dropZone:null,dropZoneConfig:null,hasBeenMounted:!1,hasRenderingListener:!1,hasUnmountedVdomChanges_:!1,height_:null,html_:null,isVdomUpdating:!1,keys_:null,maxHeight_:null,maxWidth_:null,minHeight_:null,minWidth_:null,model_:null,mounted_:!1,needsVdomUpdate:!1,parentId:"document.body",plugins_:null,rendering_:!1,silentVdomUpdate:!1,style:{},tooltips_:null,vnode_:null,width_:null,wrapperStyle_:null,_vdom:{}}}get cls(){return this._cls?Neo.clone(this._cls):[]}set cls(e){e=e||[];let t,o=this,n=o.vdom,r=o.getVdomRoot();"string"==typeof e&&(e=e.split("")),o.mounted&&(t=Neo.clone(o._cls)),o._cls=e,r&&(r.cls=[...e]),o._vdom=n,o.silentVdomUpdate?o.needsVdomUpdate=!0:o.mounted&&o.updateCls(e,t)}get listeners(){return this._listeners||{}}set listeners(e){this._listeners=e}get rendered(){return this._rendered||!1}set rendered(e){let t=this;t._rendered=e,!0===e&&t.fire("rendered",t.id)}get style(){return Neo.clone(this._style||{})}set style(e){let t=this,o=t.style;t._style=e,t.updateStyle(e,o)}get vdom(){return this._vdom}set vdom(e){let t,o=this,n=Neo.apps[o.appName],r=e,s=o.getVdomRoot();s&&o.cls&&(s.cls=o.cls),o._vdom!==r?(d.warn("vdom got replaced for: "+o.id+". Copying the content into the reference holder object"),Object.keys(o._vdom).forEach((e=>{delete o._vdom[e]})),Object.assign(o._vdom,r)):o._vdom=r,o.silentVdomUpdate?o.needsVdomUpdate=!0:(o.mounted||!o.isConstructed||o.hasRenderingListener||!0!==n?.rendering?o.mounted&&o.updateVdom(r,o.vnode):(o.hasRenderingListener=!0,t=n.on("mounted",(()=>{n.un("mounted",t),setTimeout((()=>{o.updateVdom(o.vdom,o.vnode)}),50)}))),o.hasUnmountedVdomChanges=!o.mounted&&o.hasBeenMounted)}addStyle(e){return"string"==typeof e&&(e=m.createStyleObject(e)),this.style=Object.assign(this.style,e)}afterSetAppName(e,t){e&&Neo.currentWorker.insertThemeFiles(e,this.__proto__)}afterSetConfig(e,t,o){Neo.currentWorker.isUsingViewModels&&this.bind?.[e]?.twoWay&&this.getModel().setData(e,t)}afterSetDisabled(e,t){let o=this.cls;s[e?"add":"remove"](o,"neo-disabled"),this.cls=o}afterSetDomListeners(e,t){n.updateDomListeners(this,e,t)}afterSetDroppable(e,t){let o=this;e&&!o.dropZone&&import("../draggable/DropZone.mjs").then((e=>{o.dropZone=Neo.create({module:e.default,appName:o.appName,owner:o,...o.dropZoneConfig})}))}afterSetHasUnmountedVdomChanges(e,o){if(e||!e&&o){let o,n=t.getParentIds(this),r=0,d=n.length;for(;r<d;r++)o=Neo.getComponent(n[r]),o&&(o._hasUnmountedVdomChanges=e)}}afterSetHeight(e,t){this.changeVdomRootKey("height",e)}afterSetHtml(e,t){this.changeVdomRootKey("html",e)}afterSetId(e,o){super.afterSetId(e,o),this.changeVdomRootKey("id",e),o&&t.unregister(o),t.register(this)}afterSetMaxHeight(e,t){this.changeVdomRootKey("maxHeight",e)}afterSetMaxWidth(e,t){this.changeVdomRootKey("maxWidth",e)}afterSetMinHeight(e,t){this.changeVdomRootKey("minHeight",e)}afterSetMinWidth(e,t){this.changeVdomRootKey("minWidth",e)}afterSetMounted(e,t){if(void 0!==t){let t=this;e&&(t.hasBeenMounted=!0,t.domListeners?.length>0&&setTimeout((()=>{n.mountDomListeners(t)}),300),t.fire("mounted",t.id))}}afterSetTooltips(e,t){if(e){let t=this;Neo.ns("Neo.tooltip.Base")?t.createTooltips(e):import("../tooltip/Base.mjs").then((o=>{t.createTooltips(e)}))}}afterSetVnode(e,t){void 0!==t&&this.syncVnodeTree()}afterSetWidth(e,t){this.changeVdomRootKey("width",e)}afterSetWrapperStyle(e,t){if(e||void 0!==t){let o=this,n=o.vdom;o.vdom.id?o.updateStyle(e,t,o.vdom.id):(n.style=e,o.vdom=n)}}beforeGetData(e){return this.getModel().getHierarchyData()}beforeGetWrapperStyle(e){return{...Object.assign(this.vdom.style||{},e)}}beforeSetController(t,o){return o&&o.destroy(),t?e.beforeSetInstance(t,null,{component:this}):t}beforeSetDomListeners(e,t){return Neo.isObject(e)&&(e=[e]),e||[]}beforeSetKeys(t,o){return o&&o.destroy(),t&&(t=e.beforeSetInstance(t,r,{keys:t})),t}beforeSetModel(t,o){return o&&o.destroy(),t?e.beforeSetInstance(t,"Neo.model.Component",{component:this}):null}beforeSetPlugins(t,o){return Array.isArray(t)&&t.forEach(((o,n)=>{t[n]=e.beforeSetInstance(o,null,{owner:this})})),t}changeVdomRootKey(e,t){let o=this,n=o.getVdomRoot(),r=o.vdom;t?n[e]=t:delete n[e],o.vdom=r}createTooltips(e){Array.isArray(e)||(e=[e]);let t,o=this,n=[];e.forEach((e=>{t=Neo.create("Neo.tooltip.Base",{appName:o.appName,componentId:o.id,...e}),n.push(t)})),o._tooltips=n}destroy(e=!1,o=!1){let n,r=this,d=r.parentId,s=Neo.getComponent(d),i=s?.getModel();r.domListeners=[],r.controller?.destroy(),r.controller=null,r.reference&&r.getController()?.removeReference(r),r.model?.destroy(),r.bind&&i?.removeBindings(r.id),r.plugins?.forEach((e=>{e.destroy()})),e&&d&&("document.body"===d?Neo.applyDeltas(r.appName,{action:"removeNode",id:r.vdom.id}):(n=s.vdom,l.removeVdomChild(n,r.vdom.id),s[o?"_vdom":"vdom"]=n)),t.unregister(r),super.destroy()}down(e,o=!0){return t.down(this,e,o)}focus(e=this.id){let t=this;Neo.main.DomAccess.focus({id:e||t.id}).then((e=>{})).catch((e=>{console.log("Error attempting to receive focus for component",e,t)}))}getApp(){return Neo.apps[this.appName]}getConfigInstanceByNtype(e,t){let o,n=this,r=n[e];return!r||t&&t!==r.ntype?n.parentId&&(o=Neo.getComponent(n.parentId)||Neo.get(n.parentId),o)?o.getConfigInstanceByNtype(e,t):null:r}getController(e){return this.getConfigInstanceByNtype("controller",e)}getModel(e){return Neo.currentWorker.isUsingViewModels?this.getConfigInstanceByNtype("model",e):null}getPlugin(e){e="string"!=typeof e?e:{id:e};let t,o=this;for(const n of o.plugins||[]){t=!0;for(const o in e)if(n[o]!==e[o]){t=!1;break}if(t)return n}return null}getTheme(){let e,t,o,n=this,r="neo-theme-";for(const e of n.cls||[])if(e.startsWith(r))return e;if(e=Neo.apps[n.appName],t=e?.mainView,t){o=l.getParentNodes(t.vdom,n.id);for(const e of o||[])for(const t of e.cls||[])if(t.startsWith(r))return t}return Neo.config.themes?.[0]}getVdomChild(e,t){let o=l.findVdomChild(t||this.vdom,e);return o?.vdom}getVdomRoot(){return this.vdom}getVnodeRoot(){return this.vnode}init(){this.autoRender&&this.render()}initConfig(e,t){super.initConfig(e,t);let o=this,n=o.getController(),r=o.getModel();n&&n.parseConfig(o),r&&r.parseConfig(o)}mergeConfig(...e){let t=this,o=super.mergeConfig(...e),n={...t._vdom||{},...o.vdom||{}};return t._vdom=Neo.clone(n,!0,!0),t.cls=o.cls,t[Neo.isEmpty(o.style)?"_style":"style"]=o.style,t.wrapperStyle=Neo.clone(o.wrapperStyle,!1),delete o.cls,delete o.style,delete o._vdom,delete o.vdom,delete o.wrapperStyle,o}mount(){let e,o,n=this;if(!n.vnode)throw new Error("Component vnode must be generated before mounting, use Component.render()");n.hasUnmountedVdomChanges?(n.hasUnmountedVdomChanges=!1,o=t.getChildIds(n.vnode),o.forEach((t=>{e=Neo.getComponent(t),e&&(e._hasUnmountedVdomChanges=!1)})),n.render(!0)):Neo.currentWorker.promiseMessage("main",{action:"mountDom",appName:n.appName,id:n.id,html:n.vnode.outerHTML,parentId:n.parentId,parentIndex:n.parentIndex}).then((()=>{n.mounted=!0}))}onConstructed(){super.onConstructed();let e=this;e.keys&&e.keys.register(e)}onRender(e,o){let n=this,r=Neo.apps[n.appName];if(n.rendering=!1,r){r.rendered||(r.rendering=!1,r.rendered=!0,r.fire("render")),n.vnode=e;let d,s=t.getChildIds(e),i=0,a=s.length;for(;i<a;i++)d=Neo.getComponent(s[i]),d&&(d.rendered=!0);n._rendered=!0,n.fire("rendered",n.id),o&&(n.mounted=!0,r.mounted||(r.mounted=!0,r.fire("mounted")))}}promiseVdomUpdate(e=this.vdom,t=this.vnode){let o=this;return o._vdom!==e?(d.warn("vdom got replaced for: "+o.id+". Copying the content into the reference holder object"),Object.keys(o._vdom).forEach((e=>{delete o._vdom[e]})),Object.assign(o._vdom,e)):o._vdom=e,o.silentVdomUpdate?(o._vdom=e,Promise.resolve()):new Promise(((n,r)=>{o.mounted?o.updateVdom(e,t,n,r):(o.vdom=e,n())}))}removeDomListeners(e){Array.isArray(e)||(e=[e]);let t,o,n=this.domListeners;e.forEach((e=>{for(t=0,o=n.length;t<o;t++)if(Neo.isEqual(e,n[t])){n.splice(t,1);break}})),this.domListeners=n}removeStyle(e){"string"==typeof e&&(e=[e]);let t=this.style,o=!1;return Object.entries(t).forEach((n=>{e.indexOf(n)>-1&&(delete t[n],o=!0)})),o&&(this.style=t),t}render(e){let t=this,o=e||t.autoMount,n=Neo.apps[t.appName];t.rendering=!0,n.rendered||(n.rendering=!0),t.vdom&&(t.isVdomUpdating=!0,Neo.vdom.Helper.create({appName:t.appName,autoMount:o,parentId:o?t.parentId:void 0,parentIndex:o?t.parentIndex:void 0,...t.vdom}).then((e=>{t.onRender(e,o),t.isVdomUpdating=!1})))}set(e={},t=!1){let o=this,n=o.vdom;return o.silentVdomUpdate=!0,super.set(e),o.silentVdomUpdate=!1,t||!o.needsVdomUpdate?(o._vdom=n,Promise.resolve()):o.promiseVdomUpdate()}setSilent(e={}){return this.set(e,!0)}syncVdomIds(e=this.vnode,t=this.vdom){l.syncVdomIds(e,t)}syncVnodeTree(e=this.vnode){let o,n=this,r=!1;n.syncVdomIds(),t.getChildren(n).forEach((e=>{o=p.findChildVnode(n.vnode,e.vdom.id),o?(e._vnode=o.vnode,e.rendered||(e._rendered=!0,e.fire("rendered",e.id)),e.mounted=!0):console.warn("syncVnodeTree: Could not replace the child vnode for",e.id)})),t.getParents(n).forEach(((e,t)=>{n.vnode?0===t&&n.vnode.outerHTML?e.vnode.childNodes.splice(n.parentIndex||0,0,n.vnode):p.replaceChildVnode(e.vnode,n.vnode.id,n.vnode):0===t&&p.removeChildVnode(e.vnode,n.id)}))}unmount(){let e=this;e.mounted=!1,Neo.currentWorker.promiseMessage("main",{action:"updateDom",appName:e.appName,deltas:[{action:"removeNode",id:e.vdom.id}]}).catch((t=>{console.log("Error attempting to unmount component",t,e)}))}up(e){return t.up(this.id,e)}updateCls(e,t){let o,n=this,r=n.vnode;Neo.isEqual(e,t)||(r&&(r.className=e,n.vnode=r),o={action:"updateDom",deltas:[{id:n.id,cls:{add:Neo.util.Array.difference(e,t),remove:Neo.util.Array.difference(t,e)}}]},Neo.currentWorker.isSharedWorker&&(o.appName=n.appName),Neo.currentWorker.promiseMessage("main",o).then((()=>{})).catch((e=>{console.log("Error attempting to update Component cls",e,n)})))}updateStyle(e,t,o=this.id){let n,r,d=this,s=a.compareStyles(e,t),i=l.findVdomChild(d.vdom,o),m=d.vnode&&p.findChildVnode(d.vnode,o);s&&(d.hasUnmountedVdomChanges||(d.hasUnmountedVdomChanges=!d.mounted&&d.hasBeenMounted),i.vdom.style=e,d.silentVdomUpdate?d.needsVdomUpdate=!0:d.mounted&&(r=m.vnode.style,Object.entries(s).forEach((([e,t])=>{null===t?delete m.vnode.style[e]:r[e]=t})),n={action:"updateDom",deltas:[{id:o,style:s}]},Neo.currentWorker.isSharedWorker&&(n.appName=d.appName),Neo.currentWorker.sendMessage("main",n)))}updateVdom(e,t,o,n){let r,d=this;d.isVdomUpdating?d.needsVdomUpdate=!0:(d.isVdomUpdating=!0,r={vdom:e,vnode:t},Neo.currentWorker.isSharedWorker&&(r.appName=d.appName),Neo.vdom.Helper.update(r).then((e=>{d.vnode=e.vnode,d.isVdomUpdating=!1,o&&o(),d.needsVdomUpdate&&(d.needsVdomUpdate=!1,d.vdom=d.vdom)})).catch((e=>{console.log("Error attempting to update component dom",e,d),d.isVdomUpdating=!1,n&&n()})))}}Neo.applyClassConfig(h);export{h as default};