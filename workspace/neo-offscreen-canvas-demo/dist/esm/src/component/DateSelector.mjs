import e from"../util/ClassSystem.mjs";import t from"./Base.mjs";import n from"../selection/DateSelectorModel.mjs";import a from"../util/Date.mjs";import o from"../util/Array.mjs";import r from"../util/VDom.mjs";const l=new Date,c=l.getDate(),s=l.getMonth(),d=l.getFullYear();class i extends t{static getConfig(){return{className:"Neo.component.DateSelector",ntype:"dateselector",cachedUpdate:null,cls:["neo-dateselector"],currentDate_:null,dateFormat:"Y-m-d",dayNameFormat_:"short",intlFormat_day:null,isUpdating_:!1,keys:{},locale_:Neo.config.locale,mouseWheelDelta:1,scrollNewYearFromTop:!1,selectionModel_:null,showCellBorders_:!1,showDisabledDays_:!0,showWeekends_:!0,useAnimations:!0,value_:a.convertToyyyymmdd(l),weekStartDay_:0,_vdom:{tabIndex:-1,cn:[{cls:["neo-dateselector-header"],cn:[{cls:["neo-nav-button","neo-prev-button"]},{cls:["neo-center-region"],cn:[{cls:["neo-month-text"]},{cls:["neo-year-text"]}]},{cls:["neo-nav-button","neo-next-button"]}]},{cls:["neo-dateselector-content"],cn:[]}]}}}constructor(e){super(e);let t=this,n=t.domListeners;n.push({click:{fn:t.onComponentClick,scope:t},wheel:{fn:t.onComponentWheel,scope:t}}),t.domListeners=n,t.updateHeaderMonth(0,0,!0),t.updateHeaderYear(0,!0),t.createDayViewContent(!1)}afterSetCurrentDate(e,t){let n,o,r,l,c,s=this;s.mounted&&(n=e.getDate()-t.getDate(),l=e.getMonth()-t.getMonth(),c=e.getFullYear()-t.getFullYear(),0!==l?(o="changeMonth",r=[l,c]):0!==c?(o="changeYear",r=[c]):0!==n&&s.selectionModel.select(s.id+"__"+a.convertToyyyymmdd(e)),o&&(s.containsFocus?Neo.main.DomAccess.focus({id:s.id}).then((e=>{s[o](...r)})):s[o](...r)))}afterSetDayNameFormat(e,t){this.updateHeaderDays(e,t)}afterSetIsUpdating(e,t){if(!1===e){let e=this;e.cachedUpdate&&e.cachedUpdate!==new Date(`${e.value}T00:00:00`)&&e.afterSetValue(e.value,a.convertToyyyymmdd(e.cachedUpdate)),e.cachedUpdate=null}}afterSetLocale(e,t){if(void 0!==t){let e=this,t=new Intl.DateTimeFormat(e.locale,{month:"short"}),n=e.vdom;e.updateHeaderDays(e.dayNameFormat,"",!0),e.getHeaderMonthEl().html=t.format(e.currentDate),e.vdom=n}}afterSetShowCellBorders(e,t){let n=this.cls;o[e?"remove":"add"](n,"neo-hide-inner-borders"),this.cls=n}afterSetShowDisabledDays(e,t){void 0!==t&&this.recreateDayViewContent()}afterSetShowWeekends(e,t){if(void 0!==t){let t,n,a=this,o=7;a.getCenterContentEl().cn.forEach(((a,r)=>{if(r>0)for(t=0;t<o;t++)n=a.cn[t],n.cls.includes("neo-weekend")&&(e?delete n.removeDom:n.removeDom=!0)})),a.updateHeaderDays(a.dayNameFormat,"")}}afterSetSelectionModel(e,t){void 0!==t&&e.register(this)}afterSetValue(e,t){let n=this;n.isUpdating?n.cacheUpdate():(n.currentDate=new Date(`${e}T00:00:00`),n.fire("change",{oldValue:t,value:e}))}afterSetWeekStartDay(e,t){void 0!==t&&this.recreateDayViewContent(!1,!1)}beforeSetDayNameFormat(e,t){return this.beforeSetEnumValue(e,t,"dayNameFormat",a.prototype.dayNameFormats)}beforeSetSelectionModel(t,a){return a&&a.destroy(),e.beforeSetInstance(t,n)}beforeSetWeekStartDay(e,t){return this.beforeSetEnumValue(e,t,"weekStartDay",a.prototype.weekStartDays)}cacheUpdate(e=this.currentDate){this.cachedUpdate=e}changeMonth(e,t){let n,a,o,r=this,l=t>0?"right":t<0||e<0?"left":"right";r.useAnimations?r.isUpdating?r.cacheUpdate():(r.isUpdating=!0,Neo.main.DomAccess.getBoundingClientRect({id:[r.getCenterContentEl().id,r.getHeaderMonthEl().id]}).then((c=>{a=r.vdom,o="right"===l?0:-c[0].width,a.cn.push({cls:["neo-relative"],cn:[{cls:["neo-animation-wrapper"],style:{height:`${c[0].height}px`,transform:`translateX(${o}px)`,width:2*c[0].width+"px"},cn:[{cls:["neo-dateselector-content"],cn:[]}]}]}),n=r.updateHeaderMonth(e,t,!0,c[1]),0!==t&&r.updateHeaderYear(e,!0),r.createDayViewContent(!0,a.cn[2].cn[0].cn[0]),a.cn[2].cn[0].cn["right"===l?"unshift":"push"](a.cn[1]),a.cn.splice(1,1),r.promiseVdomUpdate().then((()=>{r.changeMonthTransitionCallback({data:c[0],slideDirection:l}),r.updateHeaderMonthTransitionCallback(n),r.vdom=a,setTimeout((()=>{r.changeMonthWrapperCallback(l),r.updateHeaderMonthWrapperCallback(n),r.triggerVdomUpdate()}),300)}))}))):r.recreateContent(e,t)}changeMonthTransitionCallback(e){let t,n=this.vdom,{data:a,slideDirection:o}=e;t="right"===o?-a.width:0,n.cn[1].cn[0].style.transform=`translateX(${t}px)`,this._vdom=n}changeMonthWrapperCallback(e){let t=this.vdom;t.cn[1]=t.cn[1].cn[0].cn["right"===e?1:0],this._vdom=t}changeYear(e){let t,n,a,o,r=this;r.useAnimations?r.isUpdating?r.cacheUpdate():(r.isUpdating=!0,Neo.main.DomAccess.getBoundingClientRect({id:r.getCenterContentEl().id}).then((l=>{t=r.scrollNewYearFromTop&&e<0||!r.scrollNewYearFromTop&&e>0,a=r.vdom,o=t?0:-l.height,n={flexDirection:"column",height:2*l.height+"px",transform:`translateY(${o}px)`,width:`${l.width}px`},a.cn.push({cls:["neo-relative"],cn:[{cls:["neo-animation-wrapper"],style:n,cn:[{cls:["neo-dateselector-content"],cn:[]}]}]}),r.updateHeaderYear(e,!0),r.createDayViewContent(!0,a.cn[2].cn[0].cn[0]),a.cn[2].cn[0].cn[t?"unshift":"push"](a.cn[1]),a.cn.splice(1,1),r.promiseVdomUpdate(a).then((()=>{o=t?-l.height:0,a.cn[1].cn[0].style.transform=`translateY(${o}px)`,r.vdom=a,setTimeout((()=>{a.cn[1]=a.cn[1].cn[0].cn[t?1:0],r.triggerVdomUpdate()}),300)}))}))):r.recreateContent(0,e)}createDayNamesRow(){let e,t,n=this,o=a.clone(n.currentDate),r=0,l={cls:["neo-row","neo-header-row"],cn:[]};for(o.setDate(n.currentDate.getDate()-n.currentDate.getDay()+n.weekStartDay);r<7;r++)e={cls:["neo-cell"],cn:[{cls:["neo-cell-content"],html:n.intlFormat_day.format(o)}]},t=o.getDay(),n.showWeekends||0!==t&&6!==t||(e.removeDom=!0),l.cn.push(e),o.setDate(o.getDate()+1);return l}createDayViewContent(e,t){let n,o,r,l,i,h,m,u,p=this,g=p.currentDate,D=g.getDate(),y=g.getMonth(),v=g.getFullYear(),f=p.currentDate,C=new Date(`${p.value}T00:00:00`),w=C.getMonth(),M=C.getFullYear(),b=a.getDaysInMonth(g),S=a.getFirstDayOfMonth(g)-p.weekStartDay,k=p.vdom,F=t||p.getCenterContentEl(),Y=0;for(S=S<0?S+7:S,u=(b+S)/7>5?6:5,l=1-S,f.setDate(l),F.cn.push(p.createDayNamesRow());Y<u;Y++){for(m={cls:["neo-row"],cn:[]},h=0;h<7;h++)i=l>0&&l<=b,n=p.getCellId(v,y+1,l),r=f.getDay(),o={id:n,cls:i?["neo-cell"]:["neo-cell","neo-disabled"],tabIndex:i?-1:null,cn:[{cls:["neo-cell-content"],html:i?l:p.showDisabledDays?f.getDate():""}]},0!==r&&6!==r||(p.showWeekends||(o.removeDom=!0),o.cls.push("neo-weekend")),d===v&&s===y&&c===l&&o.cn[0].cls.push("neo-today"),M===v&&w===y&&l===D&&(o.cls.push("neo-selected"),p.selectionModel.items=[n]),m.cn.push(o),f.setDate(f.getDate()+1),l++;F.cn.push(m)}p[e?"_vdom":"vdom"]=k}focusCurrentItem(){this.focus(this.selectionModel.items[0])}getCellId(e,t,n){return(n=n.toString()).length<2&&(n="0"+n),(t=t.toString()).length<2&&(t="0"+t),this.id+"__"+e+"-"+t+"-"+n}getCenterContentEl(){return this.vdom.cn[1]}getHeaderMonthEl(){return this.vdom.cn[0].cn[1].cn[0]}getHeaderYearEl(){return this.vdom.cn[0].cn[1].cn[1]}onCellClick(e){let t=this,n=r.findVdomChild(t.vdom,e.path[0].id),o=t.currentDate;o.setDate(parseInt(n.vdom.cn[0].html)),t.value=a.convertToyyyymmdd(o)}onComponentClick(e){let t,n,o=this,r=e.path[0].cls;r.includes("neo-cell")?o.onCellClick(e):r.includes("neo-next-button")?n=1:r.includes("neo-prev-button")&&(n=-1),n&&(t=o.currentDate,t.setMonth(t.getMonth()+n),o.value=a.convertToyyyymmdd(t))}onComponentWheel(e){let t,n,o,r=this,l=r.mouseWheelDelta;Math.abs(e.deltaY)>=Math.abs(e.deltaX)?e.deltaY>=l?o=1:e.deltaY<=-l&&(o=-1):e.deltaX>=l?n=1:e.deltaX<=-l&&(n=-1),n?(t=r.currentDate,t.setMonth(t.getMonth()+n),r.value=a.convertToyyyymmdd(t)):o&&(t=r.currentDate,t.setFullYear(t.getFullYear()+o),r.value=a.convertToyyyymmdd(t))}onConstructed(){super.onConstructed(),this.selectionModel?.register(this)}recreateContent(e,t,n=!1){let a=this;a.recreateDayViewContent(!0),0!==e&&a.updateHeaderMonth(e,t,!0),0!==t&&a.updateHeaderYear(t,!0),a.triggerVdomUpdate(n)}recreateDayViewContent(e=!1,t=!0){let n=this;n.getCenterContentEl().cn=[],n.createDayViewContent(!0),t&&n.syncVdomIds(),n.triggerVdomUpdate(e)}triggerVdomUpdate(e=!1){if(!e){let e=this;e.isUpdating=!0,e.promiseVdomUpdate(e.vdom).then((()=>{e.isUpdating=!1}))}}updateHeaderDays(e,t,n=!1){let a=this;if(a.intlFormat_day=new Intl.DateTimeFormat(a.locale,{weekday:e}),void 0!==t){let e,t,o=a.getCenterContentEl().cn[0],r=a.currentDate,l=a.vdom,c=0;for(r.setDate(a.currentDate.getDate()-a.currentDate.getDay()+a.weekStartDay);c<7;c++)t=o.cn[c],t.cn[0].html=a.intlFormat_day.format(r),e=r.getDay(),a.showWeekends||0!==e&&6!==e?delete t.removeDom:t.removeDom=!0,r.setDate(r.getDate()+1);a[n?"_vdom":"vdom"]=l}}updateHeaderMonth(e,t,n=!1,a){let o,r,l=this,c=new Intl.DateTimeFormat(l.locale,{month:"short"}).format(l.currentDate),s=l.getHeaderMonthEl(),d=t>0?"bottom":t<0||e<0?"top":"bottom",i=l.vdom;return l.rendered&&l.useAnimations?(r="top"===d?0:-a.height,i.cn[0].cn[1].cn.unshift({cls:["neo-relative-header"],style:{height:a.height+"px",width:a.width+"px"},cn:[{cls:["neo-animation-wrapper-header"],cn:[],style:{height:2*a.height+"px",transform:`translateY(${r}px)`,width:a.width+"px"}}]}),o=i.cn[0].cn[1],o.cn[0].cn[0].cn.push({cls:["neo-month-text"],html:c}),o.cn[0].cn[0].cn["top"===d?"unshift":"push"](o.cn[1]),o.cn.splice(1,1),l[n?"_vdom":"vdom"]=i,{data:a,headerCenterEl:o,increment:e,yearIncrement:t}):(s.html=c,l[n?"_vdom":"vdom"]=i,null)}updateHeaderMonthTransitionCallback(e){let t,{data:n,headerCenterEl:a,increment:o,yearIncrement:r}=e,l=this.vdom;t="top"===(r>0?"bottom":r<0||o<0?"top":"bottom")?-n.height:0,a.cn[0].cn[0].style.transform=`translateY(${t}px)`,this._vdom=l}updateHeaderMonthWrapperCallback(e){let{headerCenterEl:t,increment:n,yearIncrement:a}=e,o=this.vdom,r=a>0?"bottom":a<0||n<0?"top":"bottom";t.cn[0]=t.cn[0].cn[0].cn["top"===r?1:0],this._vdom=o}updateHeaderYear(e,t=!1){let n=this,a=n.vdom;n.getHeaderYearEl().html=n.currentDate.getFullYear(),n[t?"_vdom":"vdom"]=a}}Neo.applyClassConfig(i);export{i as default};