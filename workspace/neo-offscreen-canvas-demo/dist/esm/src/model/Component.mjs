import e from"../core/Base.mjs";import t from"../util/ClassSystem.mjs";import r from"../util/Array.mjs";import a from"../core/Observable.mjs";const o=/data((?!(\.[a-z_]\w*\(\)))\.[a-z_]\w*)+/gi,n=/^\w*/;class i extends e{static getStaticConfig(){return{observable:!0}}static getConfig(){return{className:"Neo.model.Component",ntype:"component-model",bindings_:null,component:null,data_:null,parent_:null,stores_:null}}constructor(e){Neo.currentWorker.isUsingViewModels=!0,super(e),this.bindings={}}addDataProperty(e,t){let r,a,o=this;Neo.ns(e,!0,o.data),r=o.getDataScope(e),a=r.scope,a[r.key]=t,o.createDataProperties(o.data,"data")}afterSetData(e,t){e&&this.createDataProperties(e,"data")}beforeGetData(e){return e||{}}beforeSetParent(e,t){return e||this.getParent()}beforeSetStores(e,r){return e&&Object.entries(e).forEach((([r,a])=>{e[r]=t.beforeSetInstance(a)})),e}callFormatter(e,t=null){return t||(t=this.getHierarchyData()),e.call(this,t)}createBinding(e,t,r,a){let o,n,i=this,s=i.getDataScope(t),l=s.scope,c=s.key;l?.hasOwnProperty(c)?(o=Neo.ns(`${t}.${e}`,!0,i.bindings),o[r]=a):(n=i.getParent(),n?n.createBinding(e,t,r,a):console.error("No model.Component found with the specified data property",e,c,r))}createBindingByFormatter(e,t,r){let a=this;a.getFormatterVariables(t).forEach((o=>{a.createBinding(e,o,r,t)}))}createBindings(e){Object.entries(e.bind).forEach((([t,r])=>{Neo.isObject(r)&&(r=r.value),this.isStoreValue(r)||this.createBindingByFormatter(e.id,r,t)}))}createDataProperties(e,t){let r,a,o,n=this,i=Neo.ns(t,!1,n);Object.entries(e).forEach((([s,l])=>{s.startsWith("_")||(r=Object.getOwnPropertyDescriptor(i,s),o=`${t}.${s}`,"object"==typeof r&&"function"==typeof r.set||(a=e[s],n.createDataProperty(s,o,i),i[s]=a),Neo.isObject(l)&&n.createDataProperties(e[s],o))}))}createDataProperty(e,t,r=this.data){let a=this;t?.startsWith("data.")&&(t=t.substring(5)),Object.defineProperty(r,e,{get:()=>r["_"+e],set(o){let n=`_${e}`,i=r[n];r[n]?r[n]=o:Object.defineProperty(r,n,{enumerable:!1,value:o,writable:!0}),Neo.isEqual(o,i)||a.onDataPropertyChange(t||e,o,i)}})}getData(e,t=this){let r,a=this.getDataScope(e),o=a.scope,n=a.key;return o?.hasOwnProperty(n)?o[n]:(r=this.getParent(),r||console.error(`data property '${e}' does not exist.`,t),r.getData(e,t))}getDataScope(e){let t=e,r=this.data;return e.includes(".")&&(t=(e=e.split(".")).pop(),r=Neo.ns(e.join("."),!1,r)),{key:t,scope:r}}getFormatterVariables(e){if(Neo.isFunction(e)&&(e=e.toString()),"dist/production"===Neo.config.environment){let t=e.match(n)[0],r=new RegExp(`(^|[^\\w.])(${t})(?!\\w)`,"g");e=e.replace(r,"$1data")}let t=e.match(o)||[],a=[];return t.forEach((e=>{e=e.substr(5),r.add(a,e)})),a.sort(),a}getHierarchyData(e=this.getPlainData()){let t=this,r=t.getParent();return r?{...r.getHierarchyData(e),...t.getPlainData()}:t.getPlainData()}getPlainData(e=this.data){let t={};return Object.entries(e).forEach((([e,r])=>{"Object"===Neo.typeOf(r)?t[e]=this.getPlainData(r):t[e]=r})),t}getParent(){let e,t,r=this;return r.parent?r.parent:(t=r.component.parentId,e=t&&Neo.getComponent(t),e?.getModel()||null)}getStore(e,t=this){let r,a=this.stores;return a?.hasOwnProperty(e)?a[e]:(r=this.getParent(),r||console.error(`store '${e}' found inside this model or parents.`,t),r.getStore(e,t))}internalSetData(e,t,r){let a,o,n,i,s=this;Neo.isObject(e)?Object.entries(e).forEach((([e,t])=>{s.internalSetData(e,t,r)})):(a=s.getDataScope(e),i=a.scope,o=a.key,i?.hasOwnProperty(o)?i[o]=t:r?(n=s.getParent(),n?n.internalSetData(e,t,r):r.addDataProperty(e,t)):s.addDataProperty(e,t))}isStoreValue(e){return Neo.isString(e)&&e.startsWith("stores.")}onDataPropertyChange(e,t,r){let a,o,n,i,s=this,l=s.bindings&&Neo.ns(e,!1,s.bindings);l&&(n={},Object.entries(l).forEach((([e,t])=>{a=Neo.getComponent(e)||Neo.get(e),o={},i=a.getModel(),n[i.id]||(n[i.id]=i.getHierarchyData()),Object.entries(t).forEach((([e,t])=>{o[e]=i.callFormatter(t,n[i.id])})),a&&a.set(o)}))),s.fire("dataPropertyChange",{key:e,id:s.id,oldValue:r,value:t})}parseConfig(e=this.component){let t=this,r={};e.bind&&(t.createBindings(e),Object.entries(e.bind).forEach((([a,o])=>{Neo.isObject(o)&&(o=o.value),t.isStoreValue(o)?t.resolveStore(e,a,o.substring(7)):r[a]=t.callFormatter(o)})),e.set(r))}removeBindings(e){let t=this.getParent();Object.entries(this.bindings).forEach((([t,r])=>{delete r[e]})),t&&t.removeBindings(e)}resolveStore(e,t,r,a=this){e[t]=this.getStore(r)}setData(e,t){this.internalSetData(e,t,this)}setDataAtSameLevel(e,t){this.internalSetData(e,t)}}Neo.applyClassConfig(i);export{i as default};