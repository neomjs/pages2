import e from"../core/Base.mjs";import t from"../core/Observable.mjs";import n from"./mixin/TouchDomEvents.mjs";const a=[{name:"change",handler:"onChange"},{name:"click",handler:"onClick"},{name:"contextmenu",handler:"onContextMenu"},{name:"dblclick",handler:"onDoubleClick"},{name:"focusin",handler:"onFocusIn"},{name:"focusout",handler:"onFocusOut"},{name:"input",handler:"onChange"},{name:"keydown",handler:"onKeyDown"},{name:"keyup",handler:"onKeyUp"},{name:"mousedown",handler:"onMouseDown"},{name:"mouseenter",handler:"onMouseEnter",options:{capture:!0}},{name:"mouseleave",handler:"onMouseLeave",options:{capture:!0}},{name:"mouseup",handler:"onMouseUp"},{name:"wheel",handler:"onWheel",options:{passive:!1}}],o=[{name:"touchcancel",handler:"onTouchCancel"},{name:"touchend",handler:"onTouchEnd"},{name:"touchenter",handler:"onTouchEnter"},{name:"touchleave",handler:"onTouchLeave"},{name:"touchmove",handler:"onTouchMove"},{name:"touchstart",handler:"onTouchStart"}],s=["neo-c-m-scrollcontainer","neo-c-w-scrollcontainer","neo-calendar-yearcomponent","neo-circle-component","neo-dateselector","neo-gallery","neo-helix"],r={"neo-c-m-scrollcontainer":100,"neo-c-w-scrollcontainer":100,"neo-calendar-yearcomponent":300,"neo-dateselector":300},l=["neo-c-m-scrollcontainer","neo-c-w-scrollcontainer"],d={date:null,target:null},i=[],c=[];class h extends e{static getStaticConfig(){return{observable:!0}}static getConfig(){return{className:"Neo.main.DomEvents",mixins:[n],singleton:!0,remote:{app:["addDomListener","registerPreventDefaultTargets"]}}}constructor(e){super(e);let t=this;document.addEventListener("DOMContentLoaded",t.onDomContentLoaded.bind(t)),window.addEventListener("hashchange",t.onHashChange.bind(t)),Neo.config.useSharedWorkers&&window.addEventListener("beforeunload",t.onBeforeUnload.bind(t))}addDomListener(e){let t,n,a,o=this,s=0,r=e.events.length;for(;s<r;s++)t=e.events[s],o[t.handler]||(o[t.handler]=Neo.emptyFn),n=t.vnodeId||e.vnodeId,a="document.body"===n?document.body:Neo.config.useDomIds?document.getElementById(n):document.querySelector(`[data-neo-id='${n}']`),a.addEventListener(t.name,o[t.handler].bind(o));Neo.worker.Manager.sendMessage(e.origin,{action:"reply",data:e,replyId:e.id,success:!0})}addGlobalDomListeners(){let e=this;[...a].concat(Neo.config.useTouchEvents?o:[]).forEach((t=>{document.body.addEventListener(t.name,e[t.handler].bind(e),t.options)}))}getDistance(e,t,n,a){return Math.sqrt((n-e)**2+(a-t)**2)}domEventListener(e){let t=this,n=e.target,a={action:"domEvent",eventName:e.type,data:{...t.getEventData(e),id:n.id,value:n.value}};switch(e.type){case"dragend":t.dragElementId=null;break;case"dragenter":case"dragleave":if(t.dragElementId===n.id)return;break;case"dragover":t.onDragOver(e),e.preventDefault();break;case"dragstart":t.dragElementId=n.id;break;case"drop":if(!t.dragElementId||t.dragElementId===n.id)return;e.stopPropagation&&e.stopPropagation(),e.preventDefault(),a.data.srcId=t.dragElementId,t.dragElementId=null;break;case"mousemove":Object.assign(a.data,t.getMouseEventData(e));break;default:e.preventDefault()}Neo.worker.Manager.sendMessage("app",a)}getEventData(e){return{path:(e.path||e.composedPath()).map((e=>this.getTargetData(e))),target:this.getTargetData(e.target),timeStamp:e.timeStamp,type:e.type}}getKeyboardEventData(e){const{altKey:t,code:n,ctrlKey:a,key:o,keyCode:s,metaKey:r,shiftKey:l}=e;return{...this.getEventData(e),altKey:t,code:n,ctrlKey:a,key:o,keyCode:s,metaKey:r,shiftKey:l}}getMouseEventData(e){const{altKey:t,clientX:n,clientY:a,ctrlKey:o,metaKey:s,offsetX:r,offsetY:l,pageX:d,pageY:i,screenX:c,screenY:h,shiftKey:g}=e;return{...this.getEventData(e),altKey:t,clientX:n,clientY:a,ctrlKey:o,metaKey:s,offsetX:r,offsetY:l,pageX:d,pageY:i,screenX:c,screenY:h,shiftKey:g}}getPathFromElement(e){let t=[];if(e)for(t.push(e);e.parentNode;)t.push(e.parentNode),e=e.parentNode;return t}getTargetData(e){let t=e.getBoundingClientRect?.(),n={};return t&&Object.assign(n,{bottom:t.bottom,height:t.height,left:t.left,right:t.right,top:t.top,width:t.width,x:t.x,y:t.y}),{checked:e.checked,childElementCount:e.childElementCount,clientHeight:e.clientHeight,clientLeft:e.clientLeft,clientTop:e.clientTop,clientWidth:e.clientWidth,cls:e.classList?[...e.classList]:[],data:{...e.dataset},draggable:e.draggable,hidden:e.hidden,id:Neo.config.useDomIds?e.id:e.dataset?.neoId,inert:e.inert,isConnected:e.isConnected,isContentEditable:e.isContentEditable,nodeType:e.nodeType,offsetHeight:e.offsetHeight,offsetLeft:e.offsetLeft,offsetTop:e.offsetTop,offsetWidth:e.offsetWidth,rect:n,scrollHeight:e.scrollHeight,scrollLeft:e.scrollLeft,scrollTop:e.scrollTop,scrollWidth:e.scrollWidth,style:e.style?.cssText,tabIndex:e.tabIndex,tagName:e.tagName?.toLowerCase()}}getTouchCoords(e){const{touches:t,changedTouches:n}=e;return t?.[0]||n?.[0]}onBeforeUnload(e){let t=Neo.worker.Manager;t.appNames.forEach((e=>{t.broadcast({action:"disconnect",appName:e})}))}onChange(e){this.sendMessageToApp({...this.getEventData(e),valid:e.target.checkValidity(),value:e.target.value})}onClick(e){let t=this;t.sendMessageToApp(t.getMouseEventData(e)),t.testPathInclusion(e,i)&&e.preventDefault()}onContextMenu(e){let t=this;t.sendMessageToApp(t.getMouseEventData(e)),t.testPathInclusion(e,c)&&e.preventDefault()}onDomContentLoaded(){this.addGlobalDomListeners(),this.fire("domContentLoaded")}onDoubleClick(e){let t=this;t.sendMessageToApp(t.getMouseEventData(e)),t.testPathInclusion(e,i)&&e.preventDefault()}onDragOver(e){e.dataTransfer.dropEffect="move"}onFocusIn(e){this.sendMessageToApp(this.getEventData(e))}onFocusOut(e){this.sendMessageToApp(this.getEventData(e))}onHashChange(){const e=Neo.worker.Manager,t=location.hash.substr(1);e.sendMessage("app",{action:"hashChange",data:{appNames:e.appNames,hash:this.parseHash(t),hashString:t}})}onKeyDown(e){this.sendMessageToApp(this.getKeyboardEventData(e)),"INPUT"!==e.target.nodeName&&["ArrowDown","ArrowLeft","ArrowRight","ArrowUp"].includes(e.key)&&e.preventDefault()}onKeyUp(e){this.sendMessageToApp(this.getKeyboardEventData(e))}onMouseDown(e){this.sendMessageToApp(this.getMouseEventData(e))}onMouseEnter(e){let t=this,n={...t.getMouseEventData(e),fromElementId:e.fromElement?.id||null};t.sendMessageToApp(n),t.fire("mouseEnter",n)}onMouseLeave(e){let t=this,n={...t.getMouseEventData(e),toElementId:e.toElement?.id||null};t.sendMessageToApp(n),t.fire("mouseLeave",n)}onMouseUp(e){this.sendMessageToApp(this.getMouseEventData(e))}onWheel(e){let t,n=this.testPathInclusion(e,s),a=!1;if(n){if(t=n.cls,r[n.cls]){let e=new Date;d.date&&d.target===t&&e-d.date<r[t]?a=!0:Object.assign(d,{date:e,target:t})}if(!a){const{deltaX:t,deltaY:a,deltaZ:o}=e;this.sendMessageToApp({...this.getEventData(e),clientHeight:n.node.clientHeight,clientWidth:n.node.clientWidth,deltaX:t,deltaY:a,deltaZ:o,scrollLeft:n.node.scrollLeft,scrollTop:n.node.scrollTop})}l.includes(t)||e.preventDefault()}}parseHash(e){if(""===e)return{};let t,n,a,o,s=e.split("&"),r={};for(t=0;t<s.length;t++)a=s[t].split("="),a.length<2&&a.push(""),n=decodeURIComponent(a[0]),o=decodeURIComponent(a[1]),-1!==n.indexOf("[]")?(n=n.substring(0,n.indexOf("[]")),void 0===r[n]&&(r[n]=[]),r[n].push(this.parseValue(o))):r[n]=this.parseValue(o);return r}parseValue(e){return e==parseInt(e)?e=parseInt(e):"false"===e?e=!1:"true"===e&&(e=!0),e}registerPreventDefaultTargets(e){let t;switch(Array.isArray(e.cls)||(e.cls=[e.cls]),e.name){case"click":t=i;break;case"contextmenu":t=c}e.cls.forEach((e=>{t.includes(e)||t.push(e)}))}sendMessageToApp(e){Neo.worker.Manager.sendMessage("app",{action:"domEvent",eventName:e.type,data:e})}testPathInclusion(e,t){let n,a,o=t.length,s=e.path||e.composedPath(),r=0,l=s.length;for(;r<l;r++)for(a=s[r],n=0;n<o;n++)if(a.classList?.contains(t[n]))return{cls:t[n],node:a};return!1}}Neo.applyClassConfig(h);let g=Neo.create(h);Neo.applyToGlobalNs(g);export default g;