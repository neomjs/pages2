import e from"../../util/ClassSystem.mjs";import t from"../../list/Base.mjs";import i from"./Picker.mjs";import o from"../../data/Store.mjs";import l from"../../util/VDom.mjs";class s extends i{static getStaticConfig(){return{triggerActions:["all","filtered"]}}static getConfig(){return{className:"Neo.form.field.Select",ntype:"selectfield",cls:["neo-selectfield","neo-pickerfield","neo-textfield"],displayField:"name",forceSelection:!1,hintRecordId:null,keys:{Down:"onKeyDownDown",Enter:"onKeyDownEnter",Escape:"onKeyDownEscape",Right:"onKeyDownRight",Up:"onKeyDownUp"},lastManualInput:null,list:null,listConfig_:null,pickerHeight:null,record:null,store_:null,triggerAction_:"filtered",typeAhead_:!0}}constructor(e){super(e);let i=this;i.list=Neo.create({module:t,appName:i.appName,displayField:i.displayField,parentId:i.id,selectionModel:{stayInList:!1},silentSelect:!0,store:i.store,...i.listConfig}),i.list.keys._keys.push({fn:"onContainerKeyDownEnter",key:"Enter",scope:i.id},{fn:"onContainerKeyDownEscape",key:"Escape",scope:i.id}),i.list.on({createItems:i.onListCreateItems,itemClick:i.onListItemClick,itemNavigate:i.onListItemNavigate,selectPostLastItem:i.onSelectPostLastItem,selectPreFirstItem:i.onSelectPreFirstItem,scope:i}),i.typeAhead&&i.updateTypeAhead()}afterSetStore(e,t){let i,o=this;e&&(i=e.filters||[],i.push({includeEmptyValues:!0,operator:"like",property:o.displayField,value:e.get(o.value)?.[o.displayField]||o.value}),e.filters=i)}afterSetTypeAhead(e,t){this.rendered&&this.updateTypeAhead()}afterSetValue(e,t,i=!1){let o=this.list;o&&(o.silentVdomUpdate=!0),!i&&this.updateValue(!0),o&&(o.silentVdomUpdate=!1),super.afterSetValue(e,t)}beforeGetValue(e){return this.record||e}beforeSetListConfig(e,t){return e&&this.parseItemConfigs(e),e}beforeSetStore(t,i){return i&&i.destroy(),e.beforeSetInstance(t,o)}beforeSetTriggerAction(e,t){return this.beforeSetEnumValue(e,t,"triggerAction")}beforeSetValue(e,t){let i,o=this,l=o.displayField,s=o.store;return Neo.isObject(e)?(o.record=e,e[l]):(i=s.isFiltered()?s.allItems.get(e):s.get(e),i?(o.record=i,i[o.displayField]):(o.record=s.find(l,e)[0]||null,e))}createPickerComponent(){return this.list}fireChangeEvent(e,t){let i=this,o=i.record;i.forceSelection&&!o||i.fire("change",{component:i,oldValue:i.store.get(t)?t:null,value:o||e})}focusInputEl(e){let t=this,i=t.lastManualInput;t.updateTypeAheadValue(i,!0),t.value=i,Neo.main.DomAccess.focus({id:t.getInputElId()}).then((()=>{e?.apply(t)}))}getInputHintEl(){let e=l.findVdomChild(this.vdom,this.getInputHintId());return e?.vdom}getInputHintId(){return this.id+"__input-hint"}getRecord(){let e=this.list,t=e.selectionModel.getSelection()[0];return t&&this.store.get(e.getItemRecordId(t))||null}onContainerKeyDownEnter(e){this.hidePicker()}onContainerKeyDownEscape(e){this.focusInputEl(this.hidePicker)}onFocusLeave(e){let t=this;t.forceSelection&&!t.record&&(t.value=t.hintRecordId),super.onFocusLeave(e)}onInputValueChange(e){super.onInputValueChange(e),this.lastManualInput=e.value}onKeyDownDown(e){this.onKeyDownEnter(e)}onKeyDownEnter(e){let t=this;t.pickerIsMounted?(t.selectListItem(),super.onKeyDownEnter(e)):super.onKeyDownEnter(e,t.selectListItem)}onKeyDownRight(e){let t=this;t.hintRecordId&&(t.value=t.store.get(t.hintRecordId)[t.displayField])}onKeyDownUp(e){let t=this;t.pickerIsMounted?(t.selectLastListItem(),super.onKeyDownEnter(e)):super.onKeyDownEnter(e,t.selectLastListItem)}onListCreateItems(){let e=this;e.typeAhead&&e.picker?.mounted&&e.updateTypeAheadValue()}onListItemClick(e){let t=this,i=t.value,o=e[t.displayField];t.value!==o&&(t.hintRecordId=null,t.record=e,t._value=o,t.getInputHintEl().value=null,t.afterSetValue(o,i,!0),t.fire("select",{record:e,value:e[t.store.keyProperty]}))}onPickerTriggerClick(){let e,t=this;"all"!==t.triggerAction||t.pickerIsMounted||(e=t.store.getFilter(t.displayField),e&&(e.value=null)),super.onPickerTriggerClick()}onSelectPostLastItem(){this.record=null,this.focusInputEl()}onSelectPreFirstItem(){this.record=null,this.focusInputEl()}onListItemNavigate(e){this.onListItemClick(e)}selectFirstListItem(){this.selectListItem(0)}selectLastListItem(){this.selectListItem(this.store.getCount()-1)}selectListItem(e){let t=this;Neo.isNumber(e)||(e=t.hintRecordId?t.store.indexOfKey(t.hintRecordId):0),t.list.selectItem(e),t.onListItemNavigate(t.store.getAt(e))}updateTypeAhead(e=!1){let t=this,i=l.findVdomChild(t.vdom,{flag:"neo-real-input"}),o=t.vdom;t.typeAhead?i.parentNode.cn[i.index]={tag:"span",cls:["neo-input-field-wrapper"],cn:[{tag:"input",autocomplete:"off",autocorrect:"off",cls:["neo-textfield-input","neo-typeahead-input"],id:t.getInputHintId(),spellcheck:"false"},i.vdom]}:l.replaceVdomChild(o,i.parentNode.id,i.vdom),t[e?"_vdom":"vdom"]=o}updateTypeAheadValue(e=this.value,t=!1){let i,o=this,l=!1,s=o.store,n=0,r=s.getCount(),a=o.vdom,d=o.getInputHintEl();if(!o.record&&e&&e.length>0){for(;n<r;n++)if(i=s.items[n][o.displayField],0===i.toLowerCase().indexOf(e.toLowerCase())){l=!0;break}l&&d&&(d.value=e+i.substr(e.length),o.hintRecordId=s.items[n][s.keyProperty||s.model.keyProperty])}!l&&d&&(d.value="",o.hintRecordId=null),o[t?"_vdom":"vdom"]=a}updateValue(e=!1){let t,i=this,o=i.displayField,l=i.store,s=i._value,n=i.record;l&&!Neo.isEmpty(l.filters)&&(t=l.getFilter(o),t&&(t.value=n?.[o]||s)),i.typeAhead&&!i.picker?.containsFocus&&i.updateTypeAheadValue(s,e)}}Neo.applyClassConfig(s);export{s as default};