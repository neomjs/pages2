import e from"../../component/Base.mjs";import t from"../../util/Date.mjs";import n from"../../util/Array.mjs";const o=new Date,a=o.getDate(),r=o.getMonth(),s=o.getFullYear();class l extends e{static getConfig(){return{className:"Neo.calendar.view.YearComponent",bind:{calendarStore:"stores.calendars",currentDate:e=>e.currentDate,eventStore:"stores.events",locale:e=>e.locale,scrollNewYearFromTop:e=>e.scrollNewYearFromTop,showWeekends:e=>e.showWeekends,weekStartDay:e=>e.weekStartDay},cachedUpdate:null,calendarStore_:null,cls:["neo-calendar-yearcomponent"],currentDate_:null,dayNameFormat_:"narrow",eventIndicatorHigh_:3,eventIndicatorLow_:1,eventIndicatorMedium_:2,eventStore_:null,intlFormat_day:null,intlFormat_month:null,isUpdating_:!1,locale_:Neo.config.locale,monthNameFormat_:"long",needsEventUpdate:!1,owner:null,scrollNewYearFromTop:!1,showCellBorders_:!1,showDisabledDays_:!0,showWeekends_:!0,showWeekNumbers_:!0,sixWeeksPerMonth_:!1,useAnimations:!0,vdom:{cn:[{cls:["neo-content-wrapper"],cn:[{cls:["neo-year-header"],cn:[{},{cls:["neo-nav-button","neo-prev-button"]},{cls:["neo-nav-button","neo-next-button"]}]},{cls:["neo-months-container"]}]}]},weekStartDay_:0}}constructor(e){super(e);let t=this,n=t.domListeners;n.push({click:t.onNavButtonClick,delegate:".neo-nav-button",scope:t},{wheel:t.onWheel,scope:t}),t.domListeners=n,t.calendarStore.getCount()>0&&t.eventStore.getCount()>0&&t.createMonths(!0),t.updateHeaderYear()}afterSetCalendarStore(e,t){let n=this,o={load:n.onCalendarStoreLoad,recordChange:n.onCalendarStoreRecordChange,scope:n};t?.un(o),e?.on(o)}afterSetCurrentDate(e,t){if(this.isConstructed){let n=t.getFullYear(),o=e.getFullYear();o!==n?this.changeYear(o-n):console.log("## select a new day",e.getMonth(),e.getDate())}}afterSetDayNameFormat(e,t){this.updateDayNamesRows(e,t)}afterSetEventIndicatorHigh(e,t){void 0!==t&&this.createMonths()}afterSetEventIndicatorLow(e,t){void 0!==t&&this.createMonths()}afterSetEventIndicatorMedium(e,t){void 0!==t&&this.createMonths()}afterSetEventStore(e,t){let n=this,o={load:n.onEventStoreLoad,recordChange:n.onEventStoreRecordChange,scope:n};t?.un(o),e?.on(o)}afterSetLocale(e,t){if(void 0!==t){let e=this;e.updateDayNamesRows(e.dayNameFormat,"",!0),e.updateMonthNameFormat(e.monthNameFormat,"")}}afterSetMonthNameFormat(e,t){this.updateMonthNameFormat(e,t)}afterSetMounted(e,t){super.afterSetMounted(e,t);let n=this;e&&n.needsEventUpdate&&(n.createMonths(),n.needsEventUpdate=!1)}afterSetShowCellBorders(e,t){let o=this.cls;n[e?"add":"remove"](o,"neo-show-cell-borders"),this.cls=o}afterSetShowWeekends(e,t){if(void 0!==t){let t,n,o,a,r,s=this,l=s.vdom,c=0;for(;c<12;c++)for(n=l.cn[0].cn[1].cn[c].cn,r=n.length,o=1;o<r;o++)for(a=1;a<8;a++)t=n[o].cn[a],t.cls.includes("neo-weekend")&&(e?delete t.removeDom:t.removeDom=!0);s.updateDayNamesRows(s.dayNameFormat,"")}}afterSetShowWeekNumbers(e,t){if(void 0!==t){let t,n,o,a=this,r=a.vdom,s=0;for(;s<12;s++)for(t=r.cn[0].cn[1].cn[s].cn,o=t.length,n=1;n<o;n++)t[n].cn[0].removeDom=!e;a.vdom=r}}afterSetSixWeeksPerMonth(e,n){if(void 0!==n){let n=this,o=n.vdom,a=n.currentDate,r=0;for(a.setMonth(0),a.setDate(1);r<12;r++)o.cn[0].cn[1].cn[r].cn[7].removeDom=5===t.getWeeksOfMonth(a,n.weekStartDay)&&!e,a.setMonth(a.getMonth()+1);n.vdom=o}}afterSetWeekStartDay(e,t){void 0!==t&&this.createMonths()}beforeSetDayNameFormat(e,n){return this.beforeSetEnumValue(e,n,"dayNameFormat",t.prototype.dayNameFormats)}beforeSetMonthNameFormat(e,n){return this.beforeSetEnumValue(e,n,"monthNameFormat",t.prototype.monthNameFormats)}cacheUpdate(e=this.currentDate){this.cachedUpdate=e}changeYear(e){let t,n,o,a=this;a.useAnimations&&(a.isUpdating||(a.isUpdating=!0,Neo.main.DomAccess.getBoundingClientRect({id:a.id}).then((r=>{t=a.scrollNewYearFromTop&&e<0||!a.scrollNewYearFromTop&&e>0,n=a.vdom,o=t?0:-r.height,n.cn.push({cls:["neo-relative"],cn:[{cls:["neo-animation-wrapper"],cn:[{cls:["neo-content-wrapper"],cn:[{cls:["neo-year-header"],cn:[{html:a.currentDate.getFullYear()},{cls:["neo-nav-button","neo-prev-button"]},{cls:["neo-nav-button","neo-next-button"]}]},{cls:["neo-months-container"]}]}],style:{height:2*r.height+"px",transform:`translateY(${o}px)`,width:`${r.width}px`}}]}),a.createMonths(!0,n.cn[1].cn[0].cn[0].cn[1]),n.cn[1].cn[0].cn[t?"unshift":"push"](n.cn[0]),n.cn.splice(0,1),a.promiseVdomUpdate(n).then((()=>{o=t?-r.height:0,n.cn[0].cn[0].style.transform=`translateY(${o}px)`,a.vdom=n,setTimeout((()=>{n.cn[0]=n.cn[0].cn[0].cn[t?1:0],a.triggerVdomUpdate()}),300)}))}))))}createDayNamesRow(){let e,t,n=this,o=n.currentDate,a=0,r={cls:["neo-calendar-week"],cn:[{cls:["neo-cell","neo-top-left-spacer"]}]};for(o.setDate(n.currentDate.getDate()-n.currentDate.getDay()+n.weekStartDay);a<7;a++)t={cls:["neo-cell","neo-weekday-cell"],html:n.intlFormat_day.format(o)},e=o.getDay(),n.showWeekends||0!==e&&6!==e||(t.removeDom=!0),r.cn.push(t),o.setDate(o.getDate()+1);return r}createMonthContent(e,n){let o,l,c,d,h,m,i,u,D,g,p=this,v=p.calendarStore,f=n.getDate(),w=n.getMonth(),S=n.getFullYear(),y=t.clone(n),F=p.eventStore,M=p.currentDate,N=M.getMonth(),k=M.getFullYear(),C=t.getDaysInMonth(n),_=t.getFirstDayOffset(n,p.weekStartDay),b=0,Y=t.clone(n);for(g=(C+_)/7>5?6:5,h=1-_,y.setDate(h),Y.setDate(h+7);b<6;b++){for(D={cls:["neo-calendar-week"],removeDom:b===g&&!p.sixWeeksPerMonth,cn:[{cls:["neo-cell","neo-weeknumber-cell"],html:t.getWeekOfYear(Y),removeDom:!p.showWeekNumbers}]},Y.setDate(Y.getDate()+7),u=0;u<7;u++)i=h>0&&h<=C,o=p.getCellId(S,w+1,h),d=y.getDay(),l={id:o,cls:i?["neo-cell"]:["neo-cell","neo-disabled"],tabIndex:i?-1:null,cn:[{cls:["neo-cell-content"],html:i?h:p.showDisabledDays?y.getDate():""}]},c=l.cls,0!==d&&6!==d||(c.push("neo-weekend"),p.showWeekends||(l.removeDom=!0)),s===S&&r===w&&a===h&&l.cn[0].cls.push("neo-today"),k===S&&N===w&&h===f&&c.push("neo-selected"),l.removeDom||(m=F.getDayRecords(y),m=m.filter((e=>v.get(e.calendarId).active)),m.length>=p.eventIndicatorHigh?c.push("neo-events-high"):m.length>=p.eventIndicatorMedium?c.push("neo-events-medium"):m.length>=p.eventIndicatorLow&&c.push("neo-events-low")),D.cn.push(l),y.setDate(y.getDate()+1),h++;e.cn.push(D)}return e}createMonths(e=!1,n){let o=this;if(o.mounted){let a,r=o.currentDate,s=o.vdom,l=n||s.cn[0].cn[1],c=0;for(l.cn=[];c<12;c++)r.setMonth(c),r.setDate(1),a={cls:["neo-month"],cn:[{cls:["neo-month-name"],html:o.intlFormat_month.format(r)},o.createDayNamesRow()]},a=o.createMonthContent(a,t.clone(r)),l.cn.push(a);o[e?"_vdom":"vdom"]=s}else o.needsEventUpdate=!0}getCellId(e,t,n){return(n=n.toString()).length<2&&(n="0"+n),(t=t.toString()).length<2&&(t="0"+t),this.id+"__"+e+"-"+t+"-"+n}onCalendarStoreLoad(e){this.eventStore.getCount()>0&&this.createMonths()}onCalendarStoreRecordChange(e){this.createMonths()}onEventStoreLoad(e){this.calendarStore.getCount()>0&&this.createMonths()}onEventStoreRecordChange(e){this.createMonths()}onNavButtonClick(e){let t=this.currentDate;t.setFullYear(t.getFullYear()+(e.path[0].cls.includes("neo-next-button")?1:-1)),this.currentDate=t}onWheel(e){if(Math.abs(e.deltaY)>Math.abs(e.deltaX)){let t=this,n=t.currentDate;n.setFullYear(n.getFullYear()+(e.deltaY>0?1:-1)),t.currentDate=n}}triggerVdomUpdate(e=!1){if(!e){let e=this;e.isUpdating=!0,e.promiseVdomUpdate(e.vdom).then((()=>{e.isUpdating=!1}))}}updateDayNamesRows(e,t,n=!1){let o=this;if(o.intlFormat_day=new Intl.DateTimeFormat(o.locale,{weekday:e}),void 0!==t){let e,t,a,r=o.currentDate,s=o.vdom,l=1;for(r.setDate(o.currentDate.getDate()-o.currentDate.getDay()+o.weekStartDay);l<8;l++){for(t=0;t<12;t++)e=r.getDay(),a=s.cn[0].cn[1].cn[t].cn[1].cn[l],a.html=o.intlFormat_day.format(r),o.showWeekends||0!==e&&6!==e?delete a.removeDom:a.removeDom=!0;r.setDate(r.getDate()+1)}o[n?"_vdom":"vdom"]=s}}updateHeaderYear(){this.vdom.cn[0].cn[0].cn[0].html=this.currentDate.getFullYear()}updateMonthNameFormat(e,t,n=!1){let o=this;if(o.intlFormat_month=new Intl.DateTimeFormat(o.locale,{month:e}),void 0!==t){let e=o.vdom,t=0,a=o.currentDate;for(;t<12;t++)a.setMonth(t),a.setDate(1),e.cn[0].cn[1].cn[t].cn[0].html=o.intlFormat_month.format(a);o[n?"_vdom":"vdom"]=e}}}Neo.applyClassConfig(l);export{l as default};