import e from"../../../../plugin/Base.mjs";import t from"../../../../util/Date.mjs";import n from"../EventDragZone.mjs";import a from"../../../../util/VDom.mjs";class r extends e{static getConfig(){return{className:"Neo.calendar.view.week.plugin.DragDrop",isDragging:!1}}constructor(e){super(e);let t=this,n={scope:t,delegate:".neo-c-w-column"},a={scope:t,delegate:".neo-event"},r=t.owner,o=r.domListeners;o.push({"drag:end":t.onColumnDragEnd,...n},{"drag:end":t.onEventDragEnd,...a},{"drag:move":t.onColumnDragMove,...n},{"drag:move":t.onEventDragMove,...a},{"drag:start":t.onColumnDragStart,...n},{"drag:start":t.onEventDragStart,...a}),r.domListeners=o}adjustResizeEvent(e){return e.path.shift(),e.targetPath.shift(),e.target=e.path[0],e}getEventDragZone(e){let t=this,a=t.owner,r=a.eventDragZone,o=a.timeAxis,i={axisEndTime:o.getTime(a.endTime),axisStartTime:o.getTime(a.startTime),dragElement:e.dragElement,enableResizingAcrossOppositeEdge:e.enableResizingAcrossOppositeEdge,eventRecord:e.eventRecord,proxyParentId:e.proxyParentId};return r?r.set(i):a.eventDragZone=r=Neo.create({module:n,appName:t.appName,owner:a,scrollContainerId:a.getScrollContainer().id,...i,dragProxyConfig:{style:{transition:"none",willChange:"height"}}}),r}isTopLevelColumn(e){return e[0].cls.includes("neo-c-w-column")}isTopLevelEvent(e){return e.path[0].cls.includes("neo-event")}onColumnDragEnd(e){let t=this,n=t.owner,a=Symbol.for("addedRecord"),r=t[a];r&&t.isTopLevelColumn(e.path)&&(t.isDragging=!1,delete t[a],Neo.applyDeltas(t.appName,{id:n.getEventId(r.id),style:{opacity:1}}).then((()=>{n.eventDragZone.dragEnd(),n.getPlugin({flag:"resizable"}).onDragEnd(e)})))}onColumnDragMove(e){this.isTopLevelColumn(e.path)&&this.owner.eventDragZone?.dragMove(e)}onColumnDragStart(e){let n=this;if(n.isTopLevelColumn(e.targetPath)){let r,o,i,g,s,d=n.owner,l=d.timeAxis.getTime(d.startTime),m=d.calendarStore,v=e.path[0].rect,p=15,u=60*(d.timeAxis.getTime(d.endTime)-l)/p,D=v.height/u,E=Math.min(v.height,e.clientY-v.top),c=Math.floor(E/D),h=new Date(a.findVdomChild(d.vdom,e.path[0].id).vdom.flag+"T00:00:00");n.isDragging=!0,h.setHours(l),h.setMinutes(Math.min(c*p,u*p-d.minimumEventDuration)),o=t.clone(h),o.setMinutes(o.getMinutes()+d.minimumEventDuration),0===o.getHours()&&0===o.getMinutes()&&o.setMinutes(o.getMinutes()-1),s=d.eventStore.add({calendarId:d.data.activeCalendarId||m.getAt(0)[m.keyProperty],endDate:o,startDate:h,title:"New Event"})[0],n[Symbol.for("addedRecord")]=s,setTimeout((()=>{g=d.getEventId(s.id),r=a.findVdomChild(d.vdom,g).vdom,i=n.getEventDragZone({dragElement:r,enableResizingAcrossOppositeEdge:!0,eventRecord:s,proxyParentId:e.path[0].id}),d.getPlugin({flag:"resizable"}).onDragStart(e),i.dragStart(e),setTimeout((()=>{n.isDragging&&Neo.applyDeltas(n.appName,{id:g,style:{opacity:0}})}),50)}),50)}}onEventDragEnd(e){let t=this,n=t.owner;n.enableDrag&&(n.eventDragZone.dragEnd(),t.isTopLevelEvent(e)?n.eventDragZone.removeBodyCursorCls():(e=t.adjustResizeEvent(e),n.getPlugin({flag:"resizable"}).onDragEnd(e)),t.isDragging=!1)}onEventDragMove(e){let t=this,n=t.owner;n.enableDrag&&(t.isTopLevelEvent(e)||(e=t.adjustResizeEvent(e)),n.eventDragZone.dragMove(e))}onEventDragStart(e){let t=this,n=t.owner,r=n.data;if(n.enableDrag){let o,i,g=t.isTopLevelEvent(e);g||(e=t.adjustResizeEvent(e)),t.isDragging=!0,o=a.findVdomChild(n.vdom,e.path[0].id).vdom,i=t.getEventDragZone({dragElement:o,enableResizingAcrossOppositeEdge:r.events.enableResizingAcrossOppositeEdge,eventRecord:n.eventStore.get(o.flag),proxyParentId:e.path[1].id}),g?i.addBodyCursorCls():n.getPlugin({flag:"resizable"}).onDragStart(e),i.dragStart(e)}}}Neo.applyClassConfig(r);export{r as default};