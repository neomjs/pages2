import e from"../../../util/Date.mjs";import t from"../../../draggable/DragProxyComponent.mjs";import a from"../../../draggable/DragZone.mjs";import r from"../../../util/Array.mjs";import n from"../../../util/VDom.mjs";class o extends a{static getConfig(){return{className:"Neo.calendar.view.week.EventDragZone",addDragProxyCls:!1,enableResizingAcrossOppositeEdge:!0,axisEndTime:0,axisStartTime:0,columnHeight:0,columnTop:0,currentInterval:0,eventDuration:0,eventRecord:null,forceUpdate:!1,hasOverflow:!1,intervalSize:15,keepEndDate:!1,keepStartDate:!1,moveHorizontal:!1,moveInMainThread:!1,newEndDate:null,newStartDate:null,scrollFactorLeft:3,useProxyWrapper:!1}}addBodyCursorCls(){Neo.applyDeltas(this.appName,{id:"document.body",cls:{add:["neo-cursor-move"]}})}adjustEndDate(e){return 0===e.getHours()&&0===e.getMinutes()?e.setMinutes(e.getMinutes()-1):23===e.getHours()&&59===e.getMinutes()||e.getMinutes()%this.intervalSize===0||e.setMinutes(e.getMinutes()+1),e}afterSetProxyParentId(e,t){if(e&&void 0!==t){let t=this;t.dragProxy?.vdom.cn[0].id&&Neo.applyDeltas(t.appName,{action:"moveNode",id:t.dragProxy.id,index:0,parentId:e})}}createDragProxy(e){let a=this,o=Neo.getComponent(a.getDragElementRoot().id)||a.owner,s=a.dragProxyConfig?.vdom,i=n.clone(s||a.dragElement);i.cn[2].removeDom=!1;const d={module:t,appName:a.appName,moveInMainThread:a.moveInMainThread,parentId:a.proxyParentId,...a.dragProxyConfig,vdom:a.useProxyWrapper?{cn:[i]}:i};d.cls=d.cls||[],d.cls.push("neo-focus"),o&&d.cls.push(o.getTheme()),i.cls&&!a.useProxyWrapper&&d.cls.push(...i.cls),a.addDragProxyCls&&r.add(d.cls,a.dragProxyCls),Object.assign(d.style,{height:`${e.height}px`,top:e.y-a.columnTop+"px",width:`${e.width}px`}),a.dragProxy=Neo.create(d)}dragEnd(t){super.dragEnd(t);let a,r,o=this,s=o.owner,i=o.eventRecord;o.keepStartDate?(a=o.newEndDate,r=o.newStartDate||i.startDate):(r=new Date(n.findVdomChild(s.vdom,o.proxyParentId).vdom.flag+"T00:00:00"),r.setHours(o.axisStartTime),r.setMinutes(o.currentInterval*o.intervalSize),o.keepEndDate?(a=o.newEndDate||i.endDate,r=o.newStartDate||r):(a=e.clone(r),a.setMinutes(a.getMinutes()+o.eventDuration))),a=o.adjustEndDate(a),i.setSilent({endDate:a,startDate:r}),Object.assign(o,{currentInterval:0,hasOverflow:!1,keepEndDate:!1,keepStartDate:!1,newEndDate:null,newStartDate:null,proxyParentId:null}),s.getModel().getStore("events").doSort(),s.updateEvents()}dragMove(t){let a,r,n,o,s,i,d,l,u,c,p,m,g,D,f=this,v=f.axisEndTime,h=f.axisStartTime,x=f.columnHeight,y=f.eventDuration,M=0,w=f.intervalSize,E=f.keepEndDate,P=f.keepStartDate,S=t.targetPath,H=S.length,N=f.owner,C=f.eventRecord,I=!1,T=N.timeAxis;if(f.dragProxy){if(!E&&!P)for(;M<H;M++)if(S[M].cls.includes("neo-c-w-column")){f.proxyParentId=S[M].id;break}if(u=60*(v-h)/w,l=x/u,m=Math.min(x,t.clientY-f.offsetY-f.columnTop),r=Math.floor(m/l),s=e.clone(C.endDate),g=e.clone(C.startDate),E&&h>g.getHours()&&(g.setHours(h),g.setMinutes(0),y=(s-g)/60/1e3),P&&v<s.getHours()&&(s.setHours(v),s.setMinutes(0),y=(s-g)/60/1e3),E||(r=Math.min(r,u-y/w)),n=[{id:f.dragProxy.id,style:{}}],E||P)if(a=e.clone(C.startDate),a.setHours(h),a.setMinutes(0),p=N.minimumEventDuration/w,D=(C.startDate-a)/w/60/1e3,E){if(c=D+y/w,f.enableResizingAcrossOppositeEdge){if(f.forceUpdate&&r>c-p&&r<c+p)return;r>=c+p?(I=!0,f.forceUpdate=!0,s.setHours(h),s.setMinutes(r*w),s=f.adjustEndDate(s),f.newEndDate=s,g.setHours(h),g.setMinutes(c*w),f.newStartDate=g,o=(s-g)/60/60/1e3,n[0].style.top=`calc(${c*l/x*100}% + 1px)`):(f.forceUpdate=!1,f.newStartDate=null)}I||(r=Math.min(r,c-p))}else if(P){if(c=D-y/w,f.enableResizingAcrossOppositeEdge)if(r=Math.max(-y/w,r),r<=c-p)I=!0,f.forceUpdate=!0,s.setHours(h),s.setMinutes(y+c*w),s=f.adjustEndDate(s),f.newEndDate=s,g.setHours(h),g.setMinutes(y+r*w),f.newStartDate=g,o=(s-g)/60/60/1e3,m=(y/w+r)*l,m=m/x*100,n[0].style.top=`calc(${m}% + 1px)`;else{if(f.forceUpdate&&r<c+p)return;f.forceUpdate&&r>=c+p&&f.currentInterval!==r&&(f.forceUpdate=!1,f.newStartDate=null,n[0].style.top=`calc(${D*l/x*100}% + 1px)`)}I||(r=Math.max(r,c+p))}P||(r=Math.max(0,r)),f.currentInterval!==r&&(I||(E||(s.setHours(h),s.setMinutes(y+r*w)),P?(f.newEndDate=s,o=(s-C.startDate)/60/60/1e3):(g.setHours(h),g.setMinutes(r*w),m=r*l,m=m/x*100,n[0].style.top=`calc(${m}% + 1px)`),E&&(o=(C.endDate-g)/60/60/1e3)),s=f.adjustEndDate(s),n.push({id:f.dragProxy.vdom.cn[2].id,innerHTML:N.intlFormat_time.format(s)}),(E||P)&&(d=Math.round(o/(v-h)*100*1e3)/1e3,n[0].style.height=`calc(${d}% - 2px)`),n.push({id:f.dragProxy.vdom.cn[0].id,innerHTML:N.intlFormat_time.format(g)}),f.dragProxy.vdom.cn[0].id&&(i=(o&&60*o||y)/T.interval,i<=2?T.rowHeight/i<25&&!f.hasOverflow&&(n.push({id:f.dragProxy.id,cls:{add:["neo-overflow"]}}),f.hasOverflow=!0):f.hasOverflow&&(n.push({id:f.dragProxy.id,cls:{remove:["neo-overflow"]}}),f.hasOverflow=!1),Neo.applyDeltas(f.appName,n))),f.currentInterval=r}}dragStart(e){let t,a,r,n=this;Neo.main.DomAccess.getBoundingClientRect({id:[n.getDragElementRoot().id,e.path[1].id]}).then((o=>{t=(n.eventRecord.endDate-n.eventRecord.startDate)/60/1e3,a=e.clientX-o[0].left,r=e.clientY-o[0].top,Object.assign(n,{columnHeight:o[1].height,columnTop:o[1].top,dragElementRect:o[0],eventDuration:Math.round(t/n.intervalSize)*n.intervalSize,offsetX:a,offsetY:r}),n.createDragProxy(o[0]),n.fire("dragStart",{dragElementRect:o[0],id:n.id,offsetX:a,offsetY:r}),n.dragMove(e)}))}removeBodyCursorCls(){Neo.applyDeltas(this.appName,{id:"document.body",cls:{remove:["neo-cursor-move"]}})}}Neo.applyClassConfig(o);export{o as default};