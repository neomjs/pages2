import e from"../../../component/Base.mjs";import t from"../../../util/Date.mjs";import n from"../../../util/Array.mjs";import o from"./TimeAxisComponent.mjs";import a from"../../../util/VDom.mjs";const r=new Date,i=r.getDate(),l=r.getMonth(),s=r.getFullYear();class d extends e{static getStaticConfig(){return{timeAxisPositions:["end","start"]}}static getConfig(){return{className:"Neo.calendar.view.week.Component",bind:{calendarStore:"stores.calendars",currentDate:e=>e.currentDate,enableDrag:e=>e.events.enableDrag,endTime:e=>e.endTime,eventBorder:e=>e.events.border,eventStore:"stores.events",intlFormat_time:e=>e.intlFormat_time,locale:e=>e.locale,minimumEventDuration:e=>e.minimumEventDuration,showWeekends:e=>e.showWeekends,startTime:e=>e.startTime,weekStartDay:e=>e.weekStartDay},calendarStore_:null,cls:["neo-calendar-weekcomponent"],currentDate_:null,dayNameFormat_:"short",enableDrag_:!0,eventBorder_:null,eventDragZone:null,eventStore_:null,firstColumnDate:null,headerCreated:!1,intlFormat_day:null,intlFormat_time_:null,isUpdating:!1,locale_:Neo.config.locale,minimumEventDuration:30,needsEventUpdate:!1,owner:null,pluginDragDropConfig:null,pluginEventResizableConfig:null,showEventEndTime_:!1,showWeekends_:!0,timeAxis:null,timeAxisConfig:null,timeAxisPosition_:"start",vdom:{cn:[{cls:["neo-scroll-overlay"]},{cls:["neo-c-w-scrollcontainer"],flag:"neo-c-w-scrollcontainer",cn:[{cls:["neo-header-row"],flag:"neo-header-row",cn:[]},{cls:["neo-c-w-column-timeaxis-container"],flag:"neo-c-w-column-timeaxis-container",cn:[{cls:["neo-c-w-column-container"],flag:"neo-c-w-column-container",style:{},cn:[]}]}]}]},weekStartDay_:0}}constructor(e){super(e);let t=this,n=t.domListeners;n.push({dblclick:t.onEventDoubleClick,scope:t,delegate:".neo-event"},{wheel:t.onWheel,scope:t}),t.domListeners=n,t.timeAxis=Neo.create(o,{appName:t.appName,parentId:t.id,listeners:{change:t.onTimeAxisChange,scope:t},...t.timeAxisConfig}),t.getColumnTimeAxisContainer().cn["start"===t.timeAxisPosition?"unshift":"push"](t.timeAxis.vdom),t.calendarStore.getCount()>0&&t.eventStore.getCount()>0&&(t.needsEventUpdate=!0),t.updateHeader(!0,t.needsEventUpdate),t.needsEventUpdate&&t.updateEvents(!1),t.headerCreated=!0}adjustTotalHeight(e,t=!1){let n=this,o=e.rowHeight,a=e.rowsPerItem,r=e.totalHeight-o,i=n.vdom,l=0,s=[];for(;l<a;l++)s.push(`var(--c-w-background-color) ${l*o+l}px`,`var(--c-w-background-color) ${(l+1)*o+l}px`,"var(--c-w-border-color) 0");Object.assign(n.getColumnContainer().style,{backgroundImage:`linear-gradient(${s.join(",")})`,backgroundSize:`1px ${a*o+a}px`,height:`${r}px`,maxHeight:`${r}px`}),n[t?"_vdom":"vdom"]=i}afterSetCalendarStore(e,t){let n=this,o={load:n.onCalendarStoreLoad,recordChange:n.onCalendarStoreRecordChange,scope:n};t?.un(o),e?.on(o)}afterSetCurrentDate(e,t){let n=this;n.isConstructed&&(n.updateHeader(!1,!0),n.updateEvents())}afterSetDayNameFormat(e,t){let n=this;n.intlFormat_day=new Intl.DateTimeFormat(n.locale,{weekday:e}),t&&n.updateHeader()}afterSetEnableDrag(e,t){e&&!this.getPlugin({flag:"dragdrop"})&&Promise.all([import("./plugin/DragDrop.mjs"),import("./plugin/EventResizable.mjs")]).then((e=>{let t=this,n=t.plugins||[];n.push({module:e[0].default,appName:t.appName,flag:"dragdrop",...t.pluginDragDropConfig},{module:e[1].default,appName:t.appName,delegationCls:"neo-event",directions:["b","t"],flag:"resizable",...t.pluginEventResizableConfig}),t.plugins=n}))}afterSetEventBorder(e,t){let o=this.cls;t&&n.remove(o,`neo-event-border-${t}`),e&&n.add(o,`neo-event-border-${e}`),this.cls=o}afterSetEventStore(e,t){let n=this,o={load:n.onEventStoreLoad,recordChange:n.onEventStoreRecordChange,scope:n};t?.un(o),e?.on(o)}afterSetLocale(e,t){if(t){let t=this;t.intlFormat_day=new Intl.DateTimeFormat(e,{weekday:t.dayNameFormat}),t.updateHeader()}}afterSetMounted(e,t){super.afterSetMounted(e,t);let n=this;e&&(n.needsEventUpdate&&(n.updateEvents(),n.needsEventUpdate=!1),setTimeout((()=>{Neo.main.DomAccess.getBoundingClientRect({id:n.getColumnContainer().id}).then((e=>{Neo.main.DomAccess.scrollBy({direction:"left",id:n.getScrollContainer().id,value:e.width/3})}))}),20))}afterSetShowEventEndTime(e,t){void 0!==t&&this.updateEvents()}afterSetShowWeekends(e,t){let o=this,a=o.cls;n[e?"add":"remove"](a,"neo-show-weekends"),o._cls=a,void 0!==t&&(o.updateHeader(!1,!0),o.updateEvents())}afterSetTimeAxisPosition(e,t){let o=this,a=o.cls,r=o.vdom,i=o.getColumnTimeAxisContainer();n["end"===e?"add":"remove"](a,"neo-timeaxis-end"),void 0!==t&&i.cn.unshift(i.cn.pop()),o._cls=a,o.vdom=r}afterSetWeekStartDay(e,t){void 0!==t&&(this.updateHeader(!1,!0),this.updateEvents())}beforeSetDayNameFormat(e,n){return this.beforeSetEnumValue(e,n,"dayNameFormat",t.prototype.dayNameFormats)}beforeSetTimeAxisPosition(e,t){return this.beforeSetEnumValue(e,t,"timeAxisPosition")}beforeSetWeekStartDay(e,n){return this.beforeSetEnumValue(e,n,"weekStartDay",t.prototype.weekStartDays)}createColumnAndHeader(e){let n,o,a=this,r=["neo-c-w-column","neo-draggable"],d=e.getDate(),m=e.getDay(),c=["neo-date"],u=!1;return 0!==m&&6!==m||(r.push("neo-weekend"),!a.showWeekends&&(u=!0)),d===i&&e.getMonth()===l&&e.getFullYear()===s&&c.push("neo-today"),n={cls:r,flag:t.convertToyyyymmdd(e),removeDom:u},o={cls:["neo-header-row-item"],removeDom:u,cn:[{cls:["neo-day"],html:a.intlFormat_day.format(e)},{cls:c,html:d}]},{column:n,header:o}}destroy(...e){this.timeAxis=null,super.destroy(...e)}getColumnContainer(){return a.getByFlag(this.vdom,"neo-c-w-column-container")}getColumnId(e){return`${this.id}_col_${t.convertToyyyymmdd(e)}`}getColumnHeaderId(e){return`${this.id}_ch_${t.convertToyyyymmdd(e)}`}getColumnTimeAxisContainer(){return a.getByFlag(this.vdom,"neo-c-w-column-timeaxis-container")}getEventId(e){return`${this.id}__${e}`}getHeaderContainer(){return a.getByFlag(this.vdom,"neo-header-row")}getIdKey(){return"c-w"}getScrollContainer(){return a.getByFlag(this.vdom,"neo-c-w-scrollcontainer")}onCalendarStoreLoad(e){this.eventStore.getCount()>0&&this.updateEvents()}onCalendarStoreRecordChange(e){this.updateEvents()}onEventDoubleClick(e){if(this.data.events.enableEdit){!e.path[0].cls.includes("neo-event")&&e.path.shift();let t=this,n=t.owner.editEventContainer,o=e.path[0],r=a.findVdomChild(t.vdom,o.id).vdom,i=t.eventStore.get(r.flag),l=n.style;Object.assign(l,{left:`${o.rect.width+15}px`,top:r.style.top}),n.setSilent({parentId:e.path[1].id,record:i,style:l}),n.render(!0)}}onEventStoreLoad(e){this.calendarStore.getCount()>0&&this.updateEvents()}onEventStoreRecordChange(e){this.updateEvents()}onFocusChange(e){let t=e.oldPath,n=e.path;t?.[0]?.cls.includes("neo-event")&&Neo.applyDeltas(this.appName,{id:t[0].id,cls:{remove:["neo-focus"]}}),n?.[0]?.cls.includes("neo-event")&&Neo.applyDeltas(this.appName,{id:n[0].id,cls:{add:["neo-focus"]}})}onTimeAxisChange(e){let t=this;t.adjustTotalHeight(e,t.headerCreated),t.headerCreated&&t.updateEvents()}onWheel(e){if(!this.isUpdating&&Math.abs(e.deltaX)>Math.abs(e.deltaY)){let t,n,o,a=this,r=a.getColumnContainer(),i=a.firstColumnDate,l=a.getHeaderContainer(),s=0,d=50,m=e.clientWidth-d;if(e.deltaX>0&&Math.round(e.scrollLeft/m*7)>13){for(n=new Date(r.cn[r.cn.length-1].flag),r.cn.splice(0,7),l.cn.splice(0,7);s<7;s++)n.setDate(n.getDate()+1),t=a.createColumnAndHeader(n),r.cn.push(t.column),l.cn.push(t.header);i.setDate(i.getDate()+7),setTimeout((()=>{a.updateEvents(!1,14,21)}),50),o=-m}else if(e.deltaX<0&&Math.round(e.scrollLeft/m*7)<1){for(n=new Date(r.cn[0].flag),r.cn.length=14,l.cn.length=14;s<7;s++)n.setDate(n.getDate()-1),t=a.createColumnAndHeader(n),r.cn.unshift(t.column),l.cn.unshift(t.header);i.setDate(i.getDate()-7),setTimeout((()=>{a.updateEvents(!1,0,7)}),50),o=m}o&&(a.isUpdating=!0,a.promiseVdomUpdate().then((()=>{Neo.main.DomAccess.scrollBy({direction:"left",id:a.getScrollContainer().id,value:o}).then((()=>{a.isUpdating=!1}))})))}}updateEvents(e=!1,n=0,o=21){let a=this;if(a.mounted){let r,i,l,s,d,m,c,u,g,h,p,v,f,D,C,y,w=a.calendarStore,S=a.eventStore,_=a.timeAxis,E=_.getTime(a.endTime),b=_.getTime(a.startTime),x=E-b,T=t.clone(a.firstColumnDate),k=a.vdom,H=a.getColumnContainer(),$=n,F=a.showEventEndTime;for(T.setDate(T.getDate()+n);$<o;$++){for(i=H.cn[$],i.cn=[],l=S.getDayRecords(T),p=l.length,h=0;h<p;h++)if(v=l[h],r=w.get(v.calendarId),r?.active){if(d=v.endDate,D=v.startDate,E<=D.getHours()||b>=d.getHours())continue;E<d.getHours()&&(d=t.clone(d),d.setHours(E),d.setMinutes(0)),b>D.getHours()&&(D=t.clone(D),D.setHours(b),D.setMinutes(0)),s=(d-D)/60/60/1e3,m=["neo-event","neo-draggable",`neo-${r.color}`],c=60*s/_.interval,u=!1,g=Math.round(s/x*100*1e3)/1e3,f=v[S.keyProperty],C=(60*D.getHours()+D.getMinutes())/60,y=Math.round((C-b)/x*100*1e3)/1e3,c<=2&&(u=_.rowHeight*c<(F?50:34),!u||F&&_.rowHeight/c>=34||m.push("neo-overflow")),F=!(u&&1===c||!F),F&&m.push("neo-show-end-time"),i.cn.push({cls:m,flag:f,id:a.getEventId(f),tabIndex:-1,cn:[{cls:["neo-event-time"],html:a.intlFormat_time.format(v.startDate),id:`${a.id}__time__${f}`},{cls:["neo-event-title"],html:v.title,id:`${a.id}__title__${f}`},{cls:["neo-event-time","neo-event-end-time"],html:a.intlFormat_time.format(v.endDate),id:`${a.id}__enddate__${f}`,removeDom:!F}],style:{height:`calc(${g}% - 2px)`,top:`calc(${y}% + 1px)`,width:"calc(100% - 1px)"}})}T.setDate(T.getDate()+1)}a[e?"_vdom":"vdom"]=k}else a.needsEventUpdate=!0}updateHeader(e=!1,n=!1){let o,a,r,d,m,c,u=this,g=u.currentDate,h=u.vdom,p=u.getColumnContainer(),v=u.getHeaderContainer(),f=0,D=u.showWeekends;for(g.setDate(u.currentDate.getDate()-u.currentDate.getDay()+u.weekStartDay-7),u.firstColumnDate=t.clone(g);f<21;f++)o=["neo-c-w-column","neo-draggable"],a=g.getDate(),r=g.getDay(),d=["neo-date"],c=!1,0!==r&&6!==r||(o.push("neo-weekend"),!D&&(c=!0)),a===i&&g.getMonth()===l&&g.getFullYear()===s&&d.push("neo-today"),m=u.getColumnHeaderId(g),e?(p.cn.push({cls:o,flag:t.convertToyyyymmdd(g),id:u.getColumnId(g),removeDom:c}),v.cn.push({cls:["neo-header-row-item"],id:m,removeDom:c,cn:[{cls:["neo-day"],html:u.intlFormat_day.format(g),id:`${m}_day`},{cls:d,html:a,id:`${m}_date`}]})):(Object.assign(p.cn[f],{cls:o,flag:t.convertToyyyymmdd(g),id:u.getColumnId(g),removeDom:c}),Object.assign(v.cn[f],{id:m,removeDom:c}),Object.assign(v.cn[f].cn[0],{html:u.intlFormat_day.format(g),id:`${m}_day`}),Object.assign(v.cn[f].cn[1],{cls:d,html:a,id:`${m}_date`})),g.setDate(g.getDate()+1);u[n?"_vdom":"vdom"]=h}}Neo.applyClassConfig(d);export{d as default};